<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>購入品管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script id="tailwind-config">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1152d4',
            'primary-dark': '#0e3c9a',
          },
        },
      },
    };
  </script>
  <style>
    body { font-family: 'Noto Sans JP', 'Yu Gothic', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    /* 一覧を画面幅いっぱいにし、列幅を配分して横スクロールを抑える */
    .purchase-results-table { table-layout: fixed; width: 100%; }
    .purchase-results-table th,
    .purchase-results-table td { word-break: break-word; overflow-wrap: break-word; }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <header class="sticky top-0 z-30 border-b border-slate-200 bg-white">
    <div class="mx-auto flex max-w-screen-xl flex-col gap-3 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">購入品一元管理</p>
        <p class="text-2xl font-bold">購入品管理</p>
      </div>
      <div class="text-xs text-slate-500">更新: {{ now.strftime('%Y/%m/%d %H:%M') }}</div>
    </div>
    <div class="border-t border-slate-100">
      <div class="mx-auto flex max-w-screen-xl flex-wrap items-center gap-4 px-4 py-2 text-xs uppercase tracking-[0.3em]">
        {% for link in nav_links %}
        <a href="{{ link.href }}" class="py-2 {% if link.right %}ml-auto {% endif %}{% if link.active %}border-b-2 border-primary text-primary{% else %}text-slate-500 hover:text-slate-900{% endif %}">{{ link.label }}</a>
        {% endfor %}
      </div>
    </div>
  </header>

  <main class="w-full max-w-full mx-auto px-4 py-6 space-y-6">
    <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
      <div>
        <h2 class="text-lg font-semibold">購入実績一覧</h2>
        <p class="text-xs text-slate-500">入庫計上時に記録された購入実績です。納入日・購入月・仕入先・品番で絞り込めます。</p>
      </div>
      <form method="get" action="/purchase-results" class="flex flex-wrap items-end gap-3">
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">納入日（から）</span>
          <input type="date" name="delivery_date_from" value="{{ filters.delivery_date_from }}" class="rounded-xl border border-slate-200 px-3 py-2" />
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">納入日（まで）</span>
          <input type="date" name="delivery_date_to" value="{{ filters.delivery_date_to }}" class="rounded-xl border border-slate-200 px-3 py-2" />
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">購入月（YYMM）</span>
          <input type="text" name="purchase_month" value="{{ filters.purchase_month }}" placeholder="例: 2502" maxlength="4" class="rounded-xl border border-slate-200 px-3 py-2 w-24" />
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">仕入先</span>
          <select name="supplier_id" class="rounded-xl border border-slate-200 px-3 py-2 min-w-[140px]">
            <option value="">すべて</option>
            {% for s in suppliers %}
            <option value="{{ s.id }}" {% if filters.supplier_id == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">品番・品名</span>
          <input type="text" name="item_code" value="{{ filters.item_code }}" placeholder="部分一致" class="rounded-xl border border-slate-200 px-3 py-2 w-40" />
        </label>
        <button type="submit" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-dark">絞り込み</button>
        <a href="/purchase-results" class="rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">クリア</a>
      </form>
      <div class="flex flex-wrap items-center justify-between gap-2">
        <p class="text-sm text-slate-600">{{ results|length }} 件</p>
        <a id="csv-export" href="#" class="rounded-xl border border-emerald-600 px-4 py-2 text-sm font-semibold text-emerald-700 hover:bg-emerald-50">CSV ダウンロード</a>
      </div>
      <div class="rounded-xl border border-slate-200 overflow-x-auto">
        <table class="purchase-results-table text-sm">
          <thead class="bg-slate-50 text-xs uppercase text-slate-500">
            <tr>
              <th class="px-2 py-2 text-left w-[7%]">納入日</th>
              <th class="px-2 py-2 text-left w-[11%]">購入先</th>
              <th class="px-2 py-2 text-left w-[7%]">納品書番号</th>
              <th class="px-2 py-2 text-left w-[5%]">品番</th>
              <th class="px-2 py-2 text-left w-[9%]">品名</th>
              <th class="px-2 py-2 text-right w-[4%]">数量</th>
              <th class="px-2 py-2 text-right w-[5%]">単価</th>
              <th class="px-2 py-2 text-right w-[6%]">金額</th>
              <th class="px-2 py-2 text-left w-[5%]">購入月</th>
              <th class="px-2 py-2 text-left w-[8%]">科目名</th>
              <th class="px-2 py-2 text-left w-[8%]">費目名</th>
              <th class="px-2 py-2 text-left w-[10%]">購入者</th>
              <th class="px-2 py-2 text-left w-[8%]">備考</th>
              <th class="px-2 py-2 text-center w-[5%] whitespace-nowrap">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for r in results %}
            <tr class="hover:bg-slate-50 purchase-result-row" data-id="{{ r.id }}">
              <td class="px-2 py-1"><input type="date" name="delivery_date" value="{{ r.delivery_date }}" class="delivery-date-input w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1">
                <select name="supplier_id" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm">
                  {% for s in suppliers %}
                  <option value="{{ s.id }}" {% if r.supplier_id == s.id %}selected{% endif %}>{{ s.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="px-2 py-1"><input type="text" name="delivery_note_number" value="{{ r.delivery_note_number }}" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-2 font-medium text-slate-700">{{ r.item_code }}</td>
              <td class="px-2 py-2 text-slate-700">{{ r.item_name }}</td>
              <td class="px-2 py-1 text-right"><input type="number" name="quantity" value="{{ r.quantity }}" min="0" class="w-full max-w-[4rem] rounded border border-slate-200 px-2 py-1.5 text-sm text-right" /></td>
              <td class="px-2 py-1 text-right"><input type="number" name="unit_price" value="{{ r.unit_price if r.unit_price is not none else '' }}" min="0" placeholder="—" class="w-full max-w-[4.5rem] rounded border border-slate-200 px-2 py-1.5 text-sm text-right" /></td>
              <td class="px-2 py-1 text-right"><input type="number" name="amount" value="{{ r.amount if r.amount is not none else '' }}" min="0" placeholder="—" class="w-full max-w-[5rem] rounded border border-slate-200 px-2 py-1.5 text-sm text-right" /></td>
              <td class="px-2 py-1"><input type="text" name="purchase_month" value="{{ r.purchase_month }}" maxlength="4" placeholder="例: 2602" class="purchase-month-input w-full max-w-[3.5rem] rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1"><input type="text" name="account_name" value="{{ r.account_name }}" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1"><input type="text" name="expense_item_name" value="{{ r.expense_item_name }}" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1"><input type="text" name="purchaser_name" value="{{ r.purchaser_name }}" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1"><input type="text" name="note" value="{{ r.note }}" class="w-full max-w-full rounded border border-slate-200 px-2 py-1.5 text-sm" /></td>
              <td class="px-2 py-1 text-center">
                <button type="button" class="save-row rounded bg-primary px-2 py-1.5 text-xs font-semibold text-white hover:bg-primary-dark whitespace-nowrap">保存</button>
              </td>
            </tr>
            {% endfor %}
            {% if not results %}
            <tr>
              <td class="px-3 py-4 text-center text-slate-500" colspan="14">該当する購入実績はありません。</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const csvLink = document.getElementById('csv-export');
      if (csvLink) {
        const params = new URLSearchParams(window.location.search);
        csvLink.href = '/purchase-results/csv?' + params.toString();
        csvLink.setAttribute('download', 'purchase_results.csv');
      }

      // 納入日入力時に購入月（YYMM）を自動反映
      document.querySelectorAll('.delivery-date-input').forEach(function (input) {
        input.addEventListener('change', function () {
          const val = this.value.trim();
          if (!val) return;
          var m = val.match(/^(\d{4})-(\d{2})/);
          if (m) {
            var yy = m[1].slice(-2);
            var mm = m[2];
            var row = this.closest('.purchase-result-row');
            if (row) {
              var pm = row.querySelector('.purchase-month-input');
              if (pm) pm.value = yy + mm;
            }
          }
        });
      });

      document.querySelectorAll('.save-row').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const row = this.closest('.purchase-result-row');
          if (!row) return;
          const id = row.getAttribute('data-id');
          const get = function (name) {
            const el = row.querySelector('[name="' + name + '"]');
            return el ? el.value : '';
          };
          const getNum = function (name) {
            const v = get(name).trim();
            if (v === '') return null;
            const n = parseInt(v, 10);
            return isNaN(n) ? null : n;
          };
          const payload = {
            delivery_date: get('delivery_date').trim() || null,
            supplier_id: getNum('supplier_id'),
            delivery_note_number: get('delivery_note_number').trim() || null,
            quantity: getNum('quantity'),
            unit_price: getNum('unit_price'),
            amount: getNum('amount'),
            purchase_month: get('purchase_month').trim() || null,
            account_name: get('account_name').trim() || null,
            expense_item_name: get('expense_item_name').trim() || null,
            purchaser_name: get('purchaser_name').trim() || null,
            note: get('note').trim() || null,
          };
          if (payload.quantity !== null && payload.quantity < 0) {
            alert('数量は0以上で指定してください。');
            return;
          }
          btn.disabled = true;
          btn.textContent = '保存中...';
          fetch('/api/purchase-results/' + id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (res.ok) {
                btn.textContent = '保存済';
                btn.classList.remove('bg-primary', 'hover:bg-primary-dark');
                btn.classList.add('bg-slate-400');
                return;
              }
              return res.json().then(function (d) {
                throw new Error(d.detail || '保存に失敗しました。');
              });
            })
            .catch(function (err) {
              alert(err.message || '保存に失敗しました。');
              btn.disabled = false;
              btn.textContent = '保存';
            })
            .finally(function () {
              if (btn.textContent === '保存中...') {
                btn.disabled = false;
                btn.textContent = '保存';
              }
            });
        });
      });
    });
  </script>
</body>
</html>
