<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>入出庫管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script id="tailwind-config">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1152d4',
            'primary-dark': '#0e3c9a',
          },
        },
      },
    };
  </script>
  <style>
    body { font-family: 'Noto Sans JP', 'Yu Gothic', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <header class="sticky top-0 z-30 border-b border-slate-200 bg-white">
    <div class="mx-auto flex max-w-screen-xl flex-col gap-3 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">購入品一元管理</p>
        <p class="text-2xl font-bold">入出庫管理</p>
      </div>
      <div class="text-xs text-slate-500">更新: {{ now.strftime('%Y/%m/%d %H:%M') }}</div>
    </div>
    <div class="border-t border-slate-100">
      <div class="mx-auto flex max-w-screen-xl flex-wrap items-center gap-4 px-4 py-2 text-xs uppercase tracking-[0.3em]">
        {% for link in nav_links %}
        <a href="{{ link.href }}" class="py-2 {% if link.right %}ml-auto {% endif %}{% if link.active %}border-b-2 border-primary text-primary{% else %}text-slate-500 hover:text-slate-900{% endif %}">{{ link.label }}</a>
        {% endfor %}
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-screen-xl space-y-6 px-4 py-6">
    <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {% for card in kpi_cards %}
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-slate-500">
          <span>{{ card.label }}</span>
          <span class="material-symbols-outlined text-lg text-slate-400">{{ card.icon }}</span>
        </div>
        <p class="mt-3 text-3xl font-bold">{{ card.value }}</p>
        <p class="text-xs text-slate-500">{{ card.note }}</p>
      </article>
      {% endfor %}
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="flex flex-col gap-1 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h2 class="text-lg font-semibold">入庫待ち発注（発注メール送信済み）</h2>
          <p class="text-xs text-slate-500">送信後の発注はここで入庫計上します。入庫計上すると在庫に反映されます。</p>
        </div>
        <span class="text-xs text-slate-500">{{ pending_orders|length }} 件</span>
      </div>

      {% if pending_orders %}
      <div class="mt-4 overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-xs uppercase text-slate-500">
            <tr>
              <th class="px-3 py-2 text-left">PO</th>
              <th class="px-3 py-2 text-left">仕入先</th>
              <th class="px-3 py-2 text-left">発注担当</th>
              <th class="px-3 py-2 text-left">状態</th>
              <th class="px-3 py-2 text-right">明細</th>
              <th class="px-3 py-2 text-right">発注合計</th>
              <th class="px-3 py-2 text-right">入荷済</th>
              <th class="px-3 py-2 text-right">残数</th>
              <th class="px-3 py-2 text-right">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for order in pending_orders %}
            <tr class="align-top">
              <td class="px-3 py-3 text-left font-semibold">PO #{{ order.id }}<br><span class="text-xs font-normal text-slate-500">{{ order.department or '-' }}</span></td>
              <td class="px-3 py-3 text-left">{{ order.supplier_name }}</td>
              <td class="px-3 py-3 text-left">{{ order.ordered_by_user or '-' }}</td>
              <td class="px-3 py-3 text-left">
                <span class="inline-flex rounded-full border px-2 py-0.5 text-xs font-semibold {% if order.status == 'WAITING' %}border-amber-200 bg-amber-50 text-amber-700{% else %}border-indigo-200 bg-indigo-50 text-indigo-700{% endif %}">{{ order.status | status_ja }}</span>
              </td>
              <td class="px-3 py-3 text-right">{{ order.line_count }}</td>
              <td class="px-3 py-3 text-right">{{ order.total_quantity }}</td>
              <td class="px-3 py-3 text-right">{{ order.received_quantity_total }}</td>
              <td class="px-3 py-3 text-right font-semibold {% if (order.remaining_quantity_total or 0) > 0 %}text-amber-700{% else %}text-emerald-700{% endif %}">{{ order.remaining_quantity_total }}</td>
              <td class="px-3 py-3 text-right">
                <button type="button" class="btn-receive rounded-xl border border-emerald-400 px-3 py-1 text-xs font-semibold text-emerald-700 hover:bg-emerald-50" data-order-id="{{ order.id }}">
                  今回分を入庫計上
                </button>
              </td>
            </tr>
            <tr class="bg-slate-50/70">
              <td colspan="9" class="px-3 pb-3 pt-0">
                <div class="overflow-x-auto rounded-lg border border-slate-200 bg-white">
                  <table class="min-w-full text-xs">
                    <thead class="bg-slate-50 text-slate-500">
                      <tr>
                        <th class="px-2 py-1 text-left">品番</th>
                        <th class="px-2 py-1 text-left">品名</th>
                        <th class="px-2 py-1 text-left">メーカー</th>
                        <th class="px-2 py-1 text-right">発注数</th>
                        <th class="px-2 py-1 text-right">入荷済</th>
                        <th class="px-2 py-1 text-right">残数</th>
                        <th class="px-2 py-1 text-right">今回入荷</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      {% for line in order.lines %}
                      <tr>
                        <td class="px-2 py-1">{{ line.item_code or '-' }}</td>
                        <td class="px-2 py-1">{{ line.item_name or '-' }}</td>
                        <td class="px-2 py-1">{{ line.maker or '-' }}</td>
                        <td class="px-2 py-1 text-right">{{ line.quantity }}</td>
                        <td class="px-2 py-1 text-right">{{ line.received_quantity }}</td>
                        <td class="px-2 py-1 text-right font-semibold {% if (line.remaining_quantity or 0) > 0 %}text-amber-700{% else %}text-emerald-700{% endif %}">{{ line.remaining_quantity }}</td>
                        <td class="px-2 py-1 text-right">
                          {% if (line.remaining_quantity or 0) > 0 %}
                          <input
                            type="number"
                            min="0"
                            max="{{ line.remaining_quantity }}"
                            value="{{ line.remaining_quantity }}"
                            class="line-receipt-input w-20 rounded border border-slate-300 px-2 py-1 text-right"
                            data-order-id="{{ order.id }}"
                            data-line-id="{{ line.id }}"
                            data-remaining="{{ line.remaining_quantity }}"
                          />
                          {% else %}
                          <span class="text-slate-400">-</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <p class="pt-2 text-[11px] text-slate-500">分納の場合は「今回入荷」を調整して計上してください。未調整なら残数全数を入庫します。</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">入庫待ちの発注はありません。</div>
      {% endif %}
    </section>

    <section class="grid gap-4 lg:grid-cols-2">
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-3">
        <div>
          <h2 class="text-lg font-semibold">在庫調整（管理者専用）</h2>
          <p class="text-xs text-slate-500">棚卸差異など、通常運用外の差分だけをここで調整します。</p>
        </div>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">品目</span>
          <div class="relative" id="adjust-item-wrap">
            <input type="text" id="adjust-item-code" class="w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="品番または品名で検索..." autocomplete="off" />
            <div id="adjust-item-suggestions" class="absolute left-0 right-0 top-full z-10 mt-1 hidden max-h-60 overflow-auto rounded-xl border border-slate-200 bg-white shadow-lg" role="listbox"></div>
          </div>
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">調整数（増減）</span>
          <input id="adjust-delta" type="number" value="-1" class="rounded-xl border border-slate-200 px-3 py-2" />
          <span class="text-[11px] text-slate-400">例: -3（減算） / +2（加算）</span>
        </label>
        <label class="flex flex-col gap-1 text-sm">
          <span class="text-xs text-slate-500">理由</span>
          <input id="adjust-reason" type="text" placeholder="例: 棚卸差異の補正" class="rounded-xl border border-slate-200 px-3 py-2" />
        </label>
        <button id="submit-adjustment" type="button" class="rounded-xl bg-amber-600 px-4 py-2 text-sm font-semibold text-white hover:bg-amber-700">在庫調整を登録</button>
      </article>

      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-3">
        <div>
          <h2 class="text-lg font-semibold">通常出庫の運用</h2>
          <p class="text-sm text-slate-600">現場の持ち出しは在庫一覧から実施してください。ここは管理者の例外調整専用です。</p>
        </div>
        <a href="/inventory" class="inline-flex items-center gap-2 rounded-xl border border-primary px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/10">
          <span class="material-symbols-outlined text-base">open_in_new</span>
          在庫一覧を開く
        </a>
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500">
          出庫履歴は在庫一覧と履歴ページにリアルタイムで反映されます。
        </div>
      </article>
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">直近の在庫調整履歴</h2>
        <span class="text-xs text-slate-500">{{ recent_adjustments|length }} 件</span>
      </div>
      <div class="overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-xs uppercase text-slate-500">
            <tr>
              <th class="px-3 py-2 text-left">日時</th>
              <th class="px-3 py-2 text-left">品目</th>
              <th class="px-3 py-2 text-right">調整数</th>
              <th class="px-3 py-2 text-left">理由</th>
              <th class="px-3 py-2 text-left">実行者</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for tx in recent_adjustments %}
            <tr>
              <td class="px-3 py-2">{{ tx.date }}</td>
              <td class="px-3 py-2">{{ tx.item }} ({{ tx.item_code }})</td>
              <td class="px-3 py-2 text-right font-semibold">{{ tx.delta }}</td>
              <td class="px-3 py-2">{{ tx.reason }}</td>
              <td class="px-3 py-2">{{ tx.created_by or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="global-loading" class="hidden fixed inset-0 z-[70] items-center justify-center bg-slate-900/40">
    <div class="min-w-[260px] rounded-2xl border border-slate-200 bg-white px-6 py-5 shadow-2xl">
      <div class="flex items-center gap-3">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-slate-200 border-t-primary"></div>
        <div>
          <p class="text-sm font-semibold text-slate-800">処理中</p>
          <p id="global-loading-message" class="text-xs text-slate-500">しばらくお待ちください...</p>
        </div>
      </div>
    </div>
  </div>
  <div id="toast-container" class="pointer-events-none fixed right-4 top-4 z-[80] flex w-[340px] max-w-[calc(100vw-2rem)] flex-col gap-2"></div>
  <div id="confirm-modal" class="hidden fixed inset-0 z-[75] items-center justify-center px-4 py-6">
    <button type="button" id="confirm-modal-backdrop" class="absolute inset-0 bg-slate-900/40" aria-label="閉じる"></button>
    <div class="relative w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-5 shadow-2xl">
      <p class="text-sm font-semibold text-slate-900">確認</p>
      <p id="confirm-modal-message" class="mt-2 text-sm text-slate-700">この操作を実行します。よろしいですか？</p>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" id="confirm-modal-cancel" class="rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">キャンセル</button>
        <button type="button" id="confirm-modal-ok" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-dark">実行</button>
      </div>
    </div>
  </div>

  <script>
    window.ITEM_OPTIONS = {{ item_options_json | safe }};
    document.addEventListener('DOMContentLoaded', function () {
      const loadingOverlay = document.getElementById('global-loading');
      const loadingMessage = document.getElementById('global-loading-message');
      const toastContainer = document.getElementById('toast-container');
      const confirmModal = document.getElementById('confirm-modal');
      const confirmModalMessage = document.getElementById('confirm-modal-message');
      const confirmModalOk = document.getElementById('confirm-modal-ok');
      const confirmModalCancel = document.getElementById('confirm-modal-cancel');
      const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
      const adjustItem = document.getElementById('adjust-item-code');
      const adjustItemWrap = document.getElementById('adjust-item-wrap');
      const adjustSuggestions = document.getElementById('adjust-item-suggestions');
      const adjustDelta = document.getElementById('adjust-delta');
      const adjustReason = document.getElementById('adjust-reason');
      const adjustButton = document.getElementById('submit-adjustment');
      const itemOptions = Array.isArray(window.ITEM_OPTIONS) ? window.ITEM_OPTIONS : [];
      const MAX_SUGGESTIONS = 30;
      let adjustSuggestionsBlurTimer = null;

      function filterItemSuggestions(query) {
        const q = (query || '').trim().toLowerCase();
        if (!q) return itemOptions.slice(0, MAX_SUGGESTIONS);
        return itemOptions.filter(function (it) {
          const code = (it.item_code || '').toLowerCase();
          const name = (it.name || '').toLowerCase();
          return code.indexOf(q) !== -1 || name.indexOf(q) !== -1;
        }).slice(0, MAX_SUGGESTIONS);
      }

      function renderItemSuggestions(items) {
        if (!adjustSuggestions) return;
        adjustSuggestions.innerHTML = '';
        adjustSuggestions.classList.add('hidden');
        if (items.length === 0) return;
        items.forEach(function (it) {
          const label = (it.item_code || '') + ' - ' + (it.name || '') + ' (在庫: ' + (it.on_hand ?? '') + (it.unit || '') + ')';
          const div = document.createElement('div');
          div.className = 'cursor-pointer px-3 py-2 text-sm text-slate-700 hover:bg-slate-100 border-b border-slate-100 last:border-b-0';
          div.setAttribute('role', 'option');
          div.dataset.itemCode = it.item_code || '';
          div.dataset.label = label;
          div.textContent = label;
          div.addEventListener('click', function () {
            if (adjustItem) {
              adjustItem.value = label;
              adjustItem.dataset.itemCode = div.dataset.itemCode;
            }
            adjustSuggestions.classList.add('hidden');
            adjustSuggestions.innerHTML = '';
          });
          adjustSuggestions.appendChild(div);
        });
        adjustSuggestions.classList.remove('hidden');
      }

      if (adjustItem && adjustSuggestions) {
        adjustItem.addEventListener('focus', function () {
          clearTimeout(adjustSuggestionsBlurTimer);
          renderItemSuggestions(filterItemSuggestions(adjustItem.value));
        });
        adjustItem.addEventListener('input', function () {
          adjustItem.removeAttribute('data-item-code');
          renderItemSuggestions(filterItemSuggestions(adjustItem.value));
        });
        adjustItem.addEventListener('blur', function () {
          adjustSuggestionsBlurTimer = setTimeout(function () {
            adjustSuggestions.classList.add('hidden');
            adjustSuggestions.innerHTML = '';
          }, 200);
        });
      }
      const MIN_LOADING_VISIBLE_MS = 450;
      const FLASH_TOAST_KEY = 'pms_flash_toast_logistics';
      let loadingStartedAt = 0;
      let reloadScheduled = false;
      let confirmResolver = null;

      const setLoading = (isLoading, message = 'しばらくお待ちください...') => {
        if (!loadingOverlay || !loadingMessage) return;
        if (isLoading) {
          loadingStartedAt = Date.now();
          loadingMessage.textContent = message;
          loadingOverlay.classList.remove('hidden');
          loadingOverlay.classList.add('flex');
        } else {
          const elapsed = Date.now() - loadingStartedAt;
          const waitMs = Math.max(0, MIN_LOADING_VISIBLE_MS - elapsed);
          setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
          }, waitMs);
        }
      };

      const showToast = (message, kind = 'info') => {
        if (!toastContainer) return;
        const toneClass = {
          success: 'border-emerald-200 bg-emerald-50 text-emerald-800',
          error: 'border-rose-200 bg-rose-50 text-rose-800',
          info: 'border-slate-200 bg-white text-slate-800',
        };
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto rounded-xl border px-3 py-2 shadow-sm transition-opacity ${toneClass[kind] || toneClass.info}`;
        toast.innerHTML = `<p class="text-sm font-semibold">${message}</p>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0');
          setTimeout(() => toast.remove(), 200);
        }, 2800);
      };

      const consumeFlashToast = () => {
        try {
          const raw = sessionStorage.getItem(FLASH_TOAST_KEY);
          if (!raw) return;
          sessionStorage.removeItem(FLASH_TOAST_KEY);
          const payload = JSON.parse(raw);
          const message = String(payload?.message || '').trim();
          const kind = String(payload?.kind || 'info');
          if (message) showToast(message, kind);
        } catch {
          sessionStorage.removeItem(FLASH_TOAST_KEY);
        }
      };

      const reloadWithToast = (message, kind = 'success', delayMs = 900) => {
        reloadScheduled = true;
        showToast(message, kind);
        try {
          sessionStorage.setItem(
            FLASH_TOAST_KEY,
            JSON.stringify({ message: String(message || ''), kind, at: Date.now() }),
          );
        } catch {}
        setTimeout(() => location.reload(), delayMs);
      };

      const closeConfirmModal = (accepted) => {
        if (!confirmModal) return;
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
        if (confirmResolver) {
          const resolver = confirmResolver;
          confirmResolver = null;
          resolver(Boolean(accepted));
        }
      };

      const openConfirmModal = (message) => new Promise((resolve) => {
        if (!confirmModal || !confirmModalMessage) {
          resolve(false);
          return;
        }
        confirmResolver = resolve;
        confirmModalMessage.textContent = message;
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
      });

      confirmModalOk?.addEventListener('click', () => closeConfirmModal(true));
      confirmModalCancel?.addEventListener('click', () => closeConfirmModal(false));
      confirmModalBackdrop?.addEventListener('click', () => closeConfirmModal(false));
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmResolver) {
          closeConfirmModal(false);
        }
      });

      consumeFlashToast();

      const jsonRequest = async (url, options = {}) => {
        const response = await fetch(url, {
          headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
          ...options,
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.detail || 'リクエストに失敗しました。');
        }
        return payload;
      };

      document.querySelectorAll('.btn-receive').forEach((button) => {
        button.addEventListener('click', async () => {
          const orderId = Number(button.dataset.orderId || 0);
          if (!orderId) {
            showToast('発注情報が不正です。', 'error');
            return;
          }
          const inputs = Array.from(document.querySelectorAll(`.line-receipt-input[data-order-id="${orderId}"]`));
          const lines = [];
          for (const input of inputs) {
            const lineId = Number(input.dataset.lineId || 0);
            const remaining = Number(input.dataset.remaining || 0);
            const qty = Number(input.value || 0);
            if (!Number.isFinite(qty) || qty < 0) {
              showToast('今回入荷には0以上の数値を入力してください。', 'error');
              return;
            }
            if (qty > remaining) {
              showToast(`明細ID ${lineId} の今回入荷が残数を超えています。`, 'error');
              return;
            }
            if (qty > 0) {
              lines.push({ line_id: lineId, quantity: qty });
            }
          }
          if (inputs.length > 0 && lines.length === 0) {
            showToast('入荷対象がありません。今回入荷を入力してください。', 'error');
            return;
          }
          const ok = await openConfirmModal(`PO #${orderId} の今回分を入庫計上します。よろしいですか？`);
          if (!ok) return;
          try {
            setLoading(true, `PO #${orderId} を入庫計上しています...`);
            const result = await jsonRequest(`/api/logistics/inbound/${orderId}/receive`, {
              method: 'POST',
              body: JSON.stringify({ lines }),
            });
            reloadWithToast(result.message || '入庫計上を実行しました。', 'success');
          } catch (error) {
            showToast(error.message || String(error), 'error');
          } finally {
            if (!reloadScheduled) setLoading(false);
          }
        });
      });

      adjustButton?.addEventListener('click', async () => {
        try {
          const raw = String(adjustItem?.value || '').trim();
          const itemCode = (adjustItem?.dataset?.itemCode || raw.split(' - ')[0] || raw).trim();
          const delta = Number(adjustDelta?.value || 0);
          const reason = String(adjustReason?.value || '').trim();
          if (!itemCode) {
            throw new Error('品目を選択または入力してください。');
          }
          if (!Number.isFinite(delta) || delta === 0) {
            throw new Error('調整数は0以外で入力してください。');
          }
          if (!reason) {
            throw new Error('理由を入力してください。');
          }
          setLoading(true, '在庫調整を登録しています...');
          const result = await jsonRequest('/api/inventory/adjustments', {
            method: 'POST',
            body: JSON.stringify({
              item_code: itemCode,
              delta,
              reason,
            }),
          });
          reloadWithToast(result.message || '在庫調整を登録しました。', 'success');
        } catch (error) {
          showToast(error.message || String(error), 'error');
        } finally {
          if (!reloadScheduled) setLoading(false);
        }
      });
    });
  </script>
</body>
</html>
