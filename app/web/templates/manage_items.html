<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>データ管理 | 仕入品</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: "Noto Sans JP", "Yu Gothic", sans-serif; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">
  <header class="sticky top-0 z-30 bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-screen-xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <p class="text-xs text-slate-500 uppercase tracking-[0.3em]">購入品一元管理</p>
        <p class="text-2xl font-bold">データ管理</p>
      </div>
      <p class="text-xs text-slate-500">更新: {{ now.strftime('%Y/%m/%d %H:%M') }}</p>
    </div>
    <div class="border-t border-slate-100">
      <div class="max-w-screen-xl mx-auto flex flex-wrap items-center gap-4 px-4 py-2 text-xs uppercase tracking-[0.3em]">
        {% for link in nav_links %}
        <a href="{{ link.href }}" class="py-2 {% if link.right %}ml-auto {% endif %}{% if link.active %}text-blue-700 border-b-2 border-blue-700{% else %}text-slate-500 hover:text-slate-900{% endif %}">
          {{ link.label }}
        </a>
        {% endfor %}
      </div>
    </div>
  </header>

  <main class="max-w-screen-xl mx-auto px-4 py-6 space-y-4">
    <section class="rounded-2xl border border-slate-200 bg-white p-3">
      <div class="flex flex-wrap gap-2">
        {% for section in manage_sections %}
        <a href="{{ section.href }}" class="rounded-xl px-4 py-2 text-sm font-semibold {% if section.active %}bg-blue-600 text-white{% else %}border border-slate-300 text-slate-700 hover:bg-slate-50{% endif %}">
          {{ section.label }}
        </a>
        {% endfor %}
      </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-2">
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Item</p>
          <h2 class="text-lg font-semibold">仕入品の新規登録・追加 / 編集</h2>
        </div>
        <div class="space-y-1">
          <label class="text-xs text-slate-500">仕入品検索</label>
          <div class="flex gap-2">
            <input id="item-search-input" list="item-suggestions" type="search" placeholder="品番または品名で検索" class="flex-1 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            <button type="button" id="item-search-button" class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">検索</button>
          </div>
          <datalist id="item-suggestions">
            {% for item in items_data %}
            <option value="{{ item.item_code }} - {{ item.name }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <form id="item-form" class="space-y-3">
          <input type="hidden" id="item-id" value="" />
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-xs text-slate-500">品番</span>
            <input id="item-code" type="text" list="datalist-item-code" required class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存の品番から選択または新規入力" autocomplete="off" />
            <datalist id="datalist-item-code">
              {% for v in distinct_item_codes %}
              <option value="{{ v }}"></option>
              {% endfor %}
            </datalist>
          </label>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">カテゴリ</span>
              <input id="item-type" type="text" list="datalist-item-type" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存から選択または新規入力" autocomplete="off" />
              <datalist id="datalist-item-type">
                {% for v in distinct_item_types %}
                <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">用途</span>
              <input id="item-usage" type="text" list="datalist-item-usage" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存から選択または新規入力" autocomplete="off" />
              <datalist id="datalist-item-usage">
                {% for v in distinct_usages %}
                <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">部署</span>
              <input id="item-department" type="text" list="datalist-item-department" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存から選択または新規入力" autocomplete="off" />
              <datalist id="datalist-item-department">
                {% for v in distinct_departments %}
                <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">メーカー</span>
              <input id="item-manufacturer" type="text" list="datalist-item-manufacturer" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存から選択または新規入力" autocomplete="off" />
              <datalist id="datalist-item-manufacturer">
                {% for v in distinct_manufacturers %}
                <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">棚番</span>
              <input id="item-shelf" type="text" list="datalist-item-shelf" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" placeholder="既存から選択または新規入力" autocomplete="off" />
              <datalist id="datalist-item-shelf">
                {% for v in distinct_shelves %}
                <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">管理区分</span>
              <select id="item-management-type" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
                <option value="管理">管理</option>
                <option value="管理外">管理外</option>
              </select>
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2 items-end">
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">発注点</span>
              <input id="item-reorder" type="number" min="0" value="0" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span class="text-xs text-slate-500">注文数量</span>
              <input id="item-default-order-quantity" type="number" min="1" value="1" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2" title="発注時のデフォルト数量" />
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-xs text-slate-500">仕入先</span>
            <select id="item-supplier" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
              <option value="">未選択</option>
              {% for supplier in suppliers %}
              <option value="{{ supplier.id }}">{{ supplier.name }}</option>
              {% endfor %}
            </select>
          </label>
          <div class="flex flex-wrap gap-2">
            <button type="submit" class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">保存</button>
            <button type="button" id="item-delete" class="rounded-xl border border-rose-300 px-4 py-2 text-sm text-rose-700 hover:bg-rose-50">削除</button>
            <button type="button" id="item-form-reset" class="rounded-xl border border-slate-300 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">クリア</button>
          </div>
        </form>
      </article>

      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-3">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500">List</p>
          <h2 class="text-lg font-semibold">仕入品一覧</h2>
        </div>
        <div id="item-list" class="space-y-2"></div>
      </article>
    </section>
  </main>

  <div id="global-loading" class="hidden fixed inset-0 z-[70] items-center justify-center bg-slate-900/40">
    <div class="rounded-2xl bg-white px-6 py-5 shadow-2xl border border-slate-200 min-w-[260px]">
      <div class="flex items-center gap-3">
        <div class="h-6 w-6 rounded-full border-2 border-slate-200 border-t-blue-600 animate-spin"></div>
        <div>
          <p class="text-sm font-semibold text-slate-800">処理中</p>
          <p id="global-loading-message" class="text-xs text-slate-500">しばらくお待ちください...</p>
        </div>
      </div>
    </div>
  </div>
  <div id="toast-container" class="pointer-events-none fixed right-4 top-4 z-[80] flex w-[340px] max-w-[calc(100vw-2rem)] flex-col gap-2"></div>
  <div id="confirm-modal" class="hidden fixed inset-0 z-[75] items-center justify-center px-4 py-6">
    <button type="button" id="confirm-modal-backdrop" class="absolute inset-0 bg-slate-900/40" aria-label="閉じる"></button>
    <div class="relative w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-5 shadow-2xl">
      <p class="text-sm font-semibold text-slate-900">確認</p>
      <p id="confirm-modal-message" class="mt-2 text-sm text-slate-700">この操作を実行します。よろしいですか？</p>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" id="confirm-modal-cancel" class="rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">キャンセル</button>
        <button type="button" id="confirm-modal-ok" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-dark">実行</button>
      </div>
    </div>
  </div>

  <script id="initial-items-data" type="application/json">
    {{ items_data | tojson | safe }}
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const itemForm = document.getElementById('item-form');
      const itemIdInput = document.getElementById('item-id');
      const itemCodeInput = document.getElementById('item-code');
      const itemTypeInput = document.getElementById('item-type');
      const itemUsageInput = document.getElementById('item-usage');
      const itemDepartmentInput = document.getElementById('item-department');
      const itemManufacturerInput = document.getElementById('item-manufacturer');
      const itemShelfInput = document.getElementById('item-shelf');
      const itemReorderInput = document.getElementById('item-reorder');
      const itemDefaultOrderQuantityInput = document.getElementById('item-default-order-quantity');
      const itemManagementTypeSelect = document.getElementById('item-management-type');
      const itemSupplierSelect = document.getElementById('item-supplier');
      const itemReset = document.getElementById('item-form-reset');
      const itemDelete = document.getElementById('item-delete');
      const itemList = document.getElementById('item-list');
      const itemSearchInput = document.getElementById('item-search-input');
      const itemSearchButton = document.getElementById('item-search-button');
      const loadingOverlay = document.getElementById('global-loading');
      const loadingMessage = document.getElementById('global-loading-message');
      const toastContainer = document.getElementById('toast-container');
      const confirmModal = document.getElementById('confirm-modal');
      const confirmModalMessage = document.getElementById('confirm-modal-message');
      const confirmModalOk = document.getElementById('confirm-modal-ok');
      const confirmModalCancel = document.getElementById('confirm-modal-cancel');
      const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
      let confirmResolver = null;
      const openConfirmModal = (message) => new Promise((resolve) => {
        if (!confirmModal || !confirmModalMessage) { resolve(false); return; }
        confirmResolver = resolve;
        confirmModalMessage.textContent = message;
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
      });
      const closeConfirmModal = (accepted) => {
        if (!confirmModal) return;
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
        if (confirmResolver) { const r = confirmResolver; confirmResolver = null; r(Boolean(accepted)); }
      };
      confirmModalOk?.addEventListener('click', () => closeConfirmModal(true));
      confirmModalCancel?.addEventListener('click', () => closeConfirmModal(false));
      confirmModalBackdrop?.addEventListener('click', () => closeConfirmModal(false));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && confirmResolver) closeConfirmModal(false); });
      const MIN_LOADING_VISIBLE_MS = 450;
      const FLASH_TOAST_KEY = 'pms_flash_toast_manage_items';
      let loadingStartedAt = 0;

      const setLoading = (isLoading, message = 'しばらくお待ちください...') => {
        if (!loadingOverlay || !loadingMessage) return;
        if (isLoading) {
          loadingStartedAt = Date.now();
          loadingMessage.textContent = message;
          loadingOverlay.classList.remove('hidden');
          loadingOverlay.classList.add('flex');
          return;
        }
        const elapsed = Date.now() - loadingStartedAt;
        const waitMs = Math.max(0, MIN_LOADING_VISIBLE_MS - elapsed);
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
          loadingOverlay.classList.remove('flex');
        }, waitMs);
      };

      const showToast = (message, kind = 'info') => {
        if (!toastContainer) return;
        const toneClass = {
          success: 'border-emerald-200 bg-emerald-50 text-emerald-800',
          error: 'border-rose-200 bg-rose-50 text-rose-800',
          info: 'border-slate-200 bg-white text-slate-800',
        };
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto rounded-xl border px-3 py-2 shadow-sm transition-opacity ${toneClass[kind] || toneClass.info}`;
        toast.innerHTML = `<p class="text-sm font-semibold">${message}</p>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0');
          setTimeout(() => toast.remove(), 200);
        }, 2800);
      };

      const consumeFlashToast = () => {
        try {
          const raw = sessionStorage.getItem(FLASH_TOAST_KEY);
          if (!raw) return;
          sessionStorage.removeItem(FLASH_TOAST_KEY);
          const payload = JSON.parse(raw);
          const message = String(payload?.message || '').trim();
          const kind = String(payload?.kind || 'info');
          if (message) showToast(message, kind);
        } catch {
          sessionStorage.removeItem(FLASH_TOAST_KEY);
        }
      };

      const reloadWithToast = (message, kind = 'success', delayMs = 120) => {
        try {
          sessionStorage.setItem(
            FLASH_TOAST_KEY,
            JSON.stringify({ message: String(message || ''), kind, at: Date.now() }),
          );
        } catch {}
        setTimeout(() => location.reload(), delayMs);
      };

      consumeFlashToast();

      const initialItemsElement = document.getElementById('initial-items-data');
      const initialItems = initialItemsElement ? JSON.parse(initialItemsElement.textContent || '[]') : [];

      const resetItemForm = () => {
        itemIdInput.value = '';
        itemCodeInput.value = '';
        itemTypeInput.value = '';
        itemUsageInput.value = '';
        itemDepartmentInput.value = '';
        itemManufacturerInput.value = '';
        itemShelfInput.value = '';
        itemReorderInput.value = '0';
        itemDefaultOrderQuantityInput.value = '1';
        itemManagementTypeSelect.value = '管理';
        itemSupplierSelect.value = '';
      };

      const createItemRow = (item) => {
        const row = document.createElement('div');
        row.className = 'item-row rounded-xl border border-slate-200 bg-slate-50 p-3 cursor-pointer hover:bg-slate-100';
        row.dataset.id = item.id;
        row.dataset.code = item.item_code;
        row.dataset.type = item.item_type || '';
        row.dataset.usage = item.usage || '';
        row.dataset.department = item.department || '';
        row.dataset.manufacturer = item.manufacturer || '';
        row.dataset.shelf = item.shelf || '';
        row.dataset.reorder = item.reorder_point ?? 0;
        row.dataset.defaultOrderQuantity = item.default_order_quantity ?? 1;
        row.dataset.managementType = item.management_type || '管理';
        row.dataset.supplier = item.supplier_id || '';
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <p class="font-semibold">${item.item_code} - ${item.name || ''}</p>
            <span class="text-xs text-slate-500">ID ${item.id}</span>
          </div>
          <p class="text-xs text-slate-500">カテゴリ: ${item.item_type || '-'} / 用途: ${item.usage || '-'}</p>
          <p class="text-xs text-slate-500">棚番: ${item.shelf || '-'} / 部署: ${item.department || '-'} / 仕入先: ${item.supplier_name || '-'}</p>
        `;
        row.addEventListener('click', () => {
          itemIdInput.value = row.dataset.id || '';
          itemCodeInput.value = row.dataset.code || '';
          itemTypeInput.value = row.dataset.type || '';
          itemUsageInput.value = row.dataset.usage || '';
          itemDepartmentInput.value = row.dataset.department || '';
          itemManufacturerInput.value = row.dataset.manufacturer || '';
          itemShelfInput.value = row.dataset.shelf || '';
          itemReorderInput.value = row.dataset.reorder || '0';
          itemDefaultOrderQuantityInput.value = row.dataset.defaultOrderQuantity || '1';
          itemManagementTypeSelect.value = row.dataset.managementType || '管理';
          itemSupplierSelect.value = row.dataset.supplier || '';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        return row;
      };

      const renderItemList = (items) => {
        itemList.innerHTML = '';
        const fragment = document.createDocumentFragment();
        items.forEach((item) => fragment.appendChild(createItemRow(item)));
        itemList.appendChild(fragment);
      };

      const fetchItems = async (query = '') => {
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        try {
          setLoading(true, query ? '仕入品を検索しています...' : '仕入品一覧を読み込んでいます...');
          const response = await fetch(`/api/items?${params.toString()}`);
          if (!response.ok) return;
          const payload = await response.json();
          renderItemList(payload.items || []);
        } catch (error) {
          console.error(error);
          showToast('仕入品検索に失敗しました。', 'error');
        } finally {
          setLoading(false);
        }
      };

      itemForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          item_code: itemCodeInput.value.trim(),
          name: itemCodeInput.value.trim() || itemTypeInput.value.trim() || '',
          item_type: itemTypeInput.value.trim(),
          usage: itemUsageInput.value.trim(),
          department: itemDepartmentInput.value.trim(),
          manufacturer: itemManufacturerInput.value.trim(),
          shelf: itemShelfInput.value.trim(),
          reorder_point: Number(itemReorderInput.value) || 0,
          default_order_quantity: Math.max(1, Number(itemDefaultOrderQuantityInput.value) || 1),
          management_type: itemManagementTypeSelect.value || '管理',
          supplier_id: itemSupplierSelect.value ? Number(itemSupplierSelect.value) : null,
        };
        if (!payload.item_code) {
          showToast('品番は必須です。', 'error');
          return;
        }
        const id = itemIdInput.value.trim();
        const url = id ? `/api/items/${id}` : '/api/items';
        const method = id ? 'PUT' : 'POST';
        try {
          setLoading(true, id ? '仕入品を更新しています...' : '仕入品を追加しています...');
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.detail || '保存に失敗しました。');
          }
          resetItemForm();
          reloadWithToast(id ? '仕入品を更新しました。' : '仕入品を追加しました。', 'success');
        } catch (error) {
          showToast(error.message || String(error), 'error');
        } finally {
          setLoading(false);
        }
      });

      itemSearchButton?.addEventListener('click', () => fetchItems(itemSearchInput?.value || ''));
      itemSearchInput?.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') fetchItems(itemSearchInput.value || '');
      });
      itemReset?.addEventListener('click', resetItemForm);

      itemDelete?.addEventListener('click', async () => {
        const id = itemIdInput.value.trim();
        if (!id) {
          showToast('削除する仕入品を一覧から選択してください。', 'error');
          return;
        }
        const label = `${itemCodeInput.value.trim() || ''} ${itemTypeInput.value.trim() || ''}`.trim() || '（品番・品名なし）';
        const ok = await openConfirmModal(`「${label}」を削除しますか？発注明細に紐づいている場合は削除できません。在庫・在庫履歴は削除されます。`);
        if (!ok) return;
        try {
          setLoading(true, '仕入品を削除しています...');
          const response = await fetch(`/api/items/${id}`, { method: 'DELETE' });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.detail || '削除に失敗しました。');
          }
          resetItemForm();
          reloadWithToast(result.message || '仕入品を削除しました。', 'success');
        } catch (error) {
          showToast(error.message || String(error), 'error');
        } finally {
          setLoading(false);
        }
      });

      renderItemList(initialItems);
    });
  </script>
</body>
</html>
