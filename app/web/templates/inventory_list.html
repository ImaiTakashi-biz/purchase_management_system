<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在庫一覧 - 購入品一元管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script id="tailwind-config">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#1152d4",
            "primary-dark": "#0e3c9a",
          },
          fontFamily: {
            display: ["Noto Sans JP", "Inter", "sans-serif"],
          },
        },
      },
    };
  </script>
  <style>
    body {
      font-family: "Noto Sans JP", "Inter", sans-serif;
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>
  <body class="bg-slate-100 text-slate-900">
  <header class="sticky top-0 z-30 bg-white border-b border-slate-200">
    <div class="max-w-screen-xl mx-auto flex flex-col gap-3 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs text-slate-500 uppercase tracking-[0.3em]">社内向け購買管理</p>
        <p class="text-2xl font-bold text-slate-900">在庫一覧</p>
      </div>
      <div class="flex items-center gap-4 text-xs text-slate-500 sm:gap-6">
        <span class="material-symbols-outlined text-base">notifications</span>
        <span>最終更新：{{ now.strftime('%Y年%m月%d日 %H:%M') }}</span>
      </div>
    </div>
    <div class="border-t border-slate-100">
      <div class="max-w-screen-xl mx-auto flex flex-wrap items-center gap-4 px-4 py-2 text-xs uppercase tracking-[0.3em]">
        {% for link in nav_links %}
        <a href="{{ link.href }}" class="py-2 {% if link.right %}ml-auto {% endif %}{% if link.active %}text-primary border-b-2 border-primary{% else %}text-slate-500 hover:text-slate-900{% endif %}">{{ link.label }}</a>
        {% endfor %}
      </div>
    </div>
  </header>
  <div class="flex flex-1 overflow-hidden">
    <aside class="hidden lg:flex w-72 flex-shrink-0 flex-col border-r border-slate-200 bg-white">
      <div class="px-5 py-6 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500 uppercase tracking-[0.3em]">部署別用途</p>
            <p class="text-lg font-bold text-slate-900">用途ツリー</p>
          </div>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto px-5 py-6 space-y-5">
        {% for section in sidebar_structure %}
        <div class="space-y-2">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-900">{{ section.name if section.name else '未設定' }}</p>
              <span class="text-[11px] text-slate-400 flex items-center gap-2">
                <span>{{ section.categories|length }}カテゴリ</span>
                {% if section.low_stock_count %}
                <span class="rounded-full bg-red-100 px-2 py-0.5 text-[11px] font-semibold text-red-600">{{ section.low_stock_count }}</span>
                {% endif %}
              </span>
            </div>
          <div class="flex flex-wrap gap-2">
            {% for cat in section.categories %}
            {% set is_active = (selected_usage == cat.name) and (selected_department == section.name) %}
            <a href="{{ build_inventory_url(keyword, selected_category, selected_usage, usage=cat.name, department=section.name, category_override='', q='') }}" class="rounded-full border px-3 py-1 text-xs {% if is_active %}border-primary bg-primary/10 text-primary{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}">
              {{ cat.name }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </aside>
    <main class="flex-1 overflow-y-auto bg-slate-100">
      <div class="max-w-screen-xl mx-auto px-4 py-6 space-y-6">
        <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
          <form method="get" action="/inventory" class="flex flex-wrap items-end gap-3">
            <input type="hidden" name="category" value="{{ selected_category }}">
            <label class="flex flex-col gap-2 text-sm">
              <span class="text-slate-500 font-semibold">検索</span>
              <input type="text" name="q" value="{{ keyword }}" placeholder="品番・品名・部署・カテゴリ" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none">
            </label>
            <button type="submit" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white transition hover:bg-primary-dark">絞り込み</button>
          </form>
          {% if selected_department %}
          <div class="flex flex-wrap gap-2 text-xs">
            <a href="{{ build_inventory_url(keyword, selected_category, selected_usage, department=selected_department, category_override='', q='') }}" class="rounded-full border px-3 py-1 {% if not selected_category %}border-primary bg-primary/10 text-primary{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}">すべて</a>
            {% for cat in type_options %}
            <a href="{{ build_inventory_url(keyword, selected_category, selected_usage, department=selected_department, category_override=cat, q='') }}" class="rounded-full border px-3 py-1 {% if cat == selected_category %}border-primary bg-primary/10 text-primary{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}">{{ cat }}</a>
            {% endfor %}
          </div>
          {% endif %}
        </section>
        <section class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
          <div class="flex items-center justify-between border-b border-slate-100 px-6 py-3 text-sm font-semibold text-slate-700">
            <span>在庫一覧（{{ filtered_count }} / {{ total_items }} 件）</span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-slate-50 text-[11px] uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-6 py-3 text-left">棚番</th>
                  <th class="px-6 py-3 text-left">品番</th>
                  <th class="px-6 py-3 text-left">メーカー名</th>
                  <th class="px-6 py-3 text-center">在庫数</th>
                  <th class="px-6 py-3 text-center">発注点</th>
                  <th class="px-6 py-3 text-center">差分</th>
                  <th class="px-6 py-3 text-center">状態</th>
                  <th class="px-6 py-3 text-left">最終取引</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                {% for item in filtered_items %}
                <tr class="hover:bg-slate-50 cursor-pointer {% if item.stock_gap <= 0 %}bg-red-50{% endif %}"
                    data-item-code="{{ item.item_code }}"
                    data-item-name="{{ item.name }}"
                    data-item-shelf="{{ item.shelf or '未設定' }}"
                    data-item-manufacturer="{{ item.manufacturer }}"
                    data-item-on-hand="{{ item.on_hand_value }}"
                    data-item-reorder="{{ item.reorder_point }}"
                    data-item-difference="{{ item.stock_gap_label }}"
                    data-item-status="{{ item.status_label }}"
                    data-item-status-badge="{{ item.status_badge }}"
                    data-item-supplier="{{ item.supplier }}"
                    data-item-last-activity="{{ item.last_activity }}"
                    data-item-last-updated="{{ item.last_updated }}"
                    data-item-order-status="{{ item.order_status_display }}"
                    data-item-order-due="{{ item.order_due_display }}"
                >
                  <td class="px-6 py-4 text-left text-slate-700">
                    {{ item.shelf or '未設定' }}
                  </td>
                  <td class="px-6 py-4 font-semibold text-slate-800">{{ item.item_code }}</td>
                  <td class="px-6 py-4 text-slate-600">{{ item.manufacturer }}</td>
                  <td class="px-6 py-4 text-center text-slate-900">{{ item.on_hand }}</td>
                  <td class="px-6 py-4 text-center text-slate-600">{{ item.reorder_point }}</td>
                  <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center gap-2">
                      <span class="material-symbols-outlined text-xs {% if item.stock_gap > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                        {% if item.stock_gap > 0 %}arrow_upward{% else %}warning{% endif %}
                      </span>
                      <span data-role="stock-gap" class="text-xs font-semibold {% if item.stock_gap > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">{{ item.stock_gap_label }}</span>
                    </span>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <span data-role="status-badge" class="status-badge inline-flex items-center justify-center rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide {{ item.status_badge }}">{{ item.status_label }}</span>
                  </td>
                  <td class="px-6 py-4">
                    <p data-role="last-activity" class="text-sm font-semibold text-slate-900">{{ item.last_activity }}</p>
                    <p data-role="last-updated" class="text-[11px] text-slate-500">{{ item.last_updated }}</p>
                    {% if item.order_status_display %}
                    <p data-role="order-status" class="text-[11px] font-medium text-primary">{{ item.order_status_display }}{% if item.order_due_display %} 納期: {{ item.order_due_display }}{% endif %}</p>
                    {% else %}
                    <p data-role="order-status" class="text-[11px] text-slate-400">-</p>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
    <div id="inventory-modal" class="fixed inset-0 hidden z-50 items-center justify-center px-4 py-6">
      <div class="absolute inset-0 bg-slate-900/40" data-modal-close></div>
      <div class="relative w-full max-w-md rounded-2xl border border-slate-200 bg-white p-5 shadow-2xl">
        <button type="button" class="absolute right-3 top-3 text-slate-400 transition hover:text-slate-600" data-modal-close aria-label="閉じる">
          <span class="material-symbols-outlined">close</span>
        </button>
        <div class="space-y-3">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500">在庫操作</p>
          <div>
            <p id="inventory-modal-item-name" class="text-lg font-semibold text-slate-900">-</p>
            <p id="inventory-modal-item-code" class="text-sm text-slate-500">-</p>
          </div>
          <div class="grid gap-2 text-sm text-slate-500">
            <div class="flex justify-between">
              <span>棚番</span>
              <span id="inventory-modal-shelf">未設定</span>
            </div>
            <div class="flex justify-between">
              <span>メーカー</span>
              <span id="inventory-modal-manufacturer">-</span>
            </div>
          </div>
          <div class="space-y-2">
            <p class="text-xs text-slate-400">在庫数</p>
            <div class="flex items-center justify-between gap-3 rounded-xl border border-slate-200 px-3 py-2 text-3xl font-bold text-slate-900">
              <button type="button" id="inventory-modal-decrement" class="h-10 w-10 rounded-full border border-slate-200 text-2xl text-slate-600 transition hover:border-slate-400 hover:text-slate-900">-</button>
              <span id="inventory-modal-count" class="text-3xl font-bold cursor-pointer select-none">0</span>
              <button type="button" id="inventory-modal-increment" class="h-10 w-10 rounded-full border border-slate-200 text-2xl text-slate-600 transition hover:border-slate-400 hover:text-slate-900">+</button>
            </div>
            <div class="grid gap-1 text-xs text-slate-500">
              <div class="flex justify-between">
                <span>発注点</span>
                <span id="inventory-modal-reorder">0</span>
              </div>
              <div class="flex justify-between">
                <span>差分</span>
                <span id="inventory-modal-gap">0</span>
              </div>
              <div class="flex justify-between">
                <span>状態</span>
                <span id="inventory-modal-status" class="font-semibold text-slate-900">-</span>
              </div>
              <span id="inventory-modal-status-badge" class="inline-flex items-center justify-center rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide text-slate-900">-</span>
            </div>
          </div>
          <div class="space-y-1 text-[11px] text-slate-500">
            <p>最終取引: <span id="inventory-modal-last-activity">-</span></p>
            <p>更新日時: <span id="inventory-modal-last-updated">-</span></p>
            <p>発注状況: <span id="inventory-modal-order-status">-</span></p>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-3">
          <button type="button" data-modal-close class="rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300">キャンセル</button>
          <button type="button" id="inventory-modal-confirm" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white transition hover:bg-primary-dark">確定</button>
        </div>
      </div>
    </div>
    <div id="global-loading" class="hidden fixed inset-0 z-[70] items-center justify-center bg-slate-900/40">
      <div class="rounded-2xl bg-white px-6 py-5 shadow-2xl border border-slate-200 min-w-[260px]">
        <div class="flex items-center gap-3">
          <div class="h-6 w-6 rounded-full border-2 border-slate-200 border-t-primary animate-spin"></div>
          <div>
            <p class="text-sm font-semibold text-slate-800">処理中</p>
            <p id="global-loading-message" class="text-xs text-slate-500">しばらくお待ちください...</p>
          </div>
        </div>
      </div>
    </div>
    <div id="toast-container" class="pointer-events-none fixed right-4 top-4 z-[80] flex w-[340px] max-w-[calc(100vw-2rem)] flex-col gap-2"></div>
    <script id="inventory-context" type="application/json">
      {{ {'alert_message': alert_message} | tojson | safe }}
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('inventory-modal');
        if (!modal) {
          return;
        }
        const closeTriggers = modal.querySelectorAll('[data-modal-close]');
        const decrementButton = document.getElementById('inventory-modal-decrement');
        const incrementButton = document.getElementById('inventory-modal-increment');
        const quantityDisplay = document.getElementById('inventory-modal-count');
        const reorderDisplay = document.getElementById('inventory-modal-reorder');
        const gapDisplay = document.getElementById('inventory-modal-gap');
        const statusText = document.getElementById('inventory-modal-status');
        const statusBadge = document.getElementById('inventory-modal-status-badge');
        const shelfDisplay = document.getElementById('inventory-modal-shelf');
        const itemCodeDisplay = document.getElementById('inventory-modal-item-code');
        const itemNameDisplay = document.getElementById('inventory-modal-item-name');
        const manufacturerDisplay = document.getElementById('inventory-modal-manufacturer');
        const lastActivityDisplay = document.getElementById('inventory-modal-last-activity');
        const lastUpdatedDisplay = document.getElementById('inventory-modal-last-updated');
        const orderStatusDisplay = document.getElementById('inventory-modal-order-status');
        const confirmButton = document.getElementById('inventory-modal-confirm');
        const recentContainer = document.getElementById('recent-transactions-list');
        const recentCount = document.getElementById('recent-transactions-count');
        const loadingOverlay = document.getElementById('global-loading');
        const loadingMessage = document.getElementById('global-loading-message');
        const toastContainer = document.getElementById('toast-container');
        const contextEl = document.getElementById('inventory-context');
        const context = contextEl ? JSON.parse(contextEl.textContent || '{}') : {};
        const MIN_LOADING_VISIBLE_MS = 450;
        let loadingStartedAt = 0;
        const formatInteger = (value) => Number(value || 0).toLocaleString('ja-JP');
        const parseIntegerValue = (value) => Number(String(value || '').replace(/,/g, '')) || 0;
        const setLoading = (isLoading, message = 'しばらくお待ちください...') => {
          if (!loadingOverlay || !loadingMessage) {
            return;
          }
          if (isLoading) {
            loadingStartedAt = Date.now();
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            return;
          }
          const elapsed = Date.now() - loadingStartedAt;
          const waitMs = Math.max(0, MIN_LOADING_VISIBLE_MS - elapsed);
          setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
          }, waitMs);
        };
        const showToast = (message, kind = 'info') => {
          if (!toastContainer) {
            return;
          }
          const toneClass = {
            success: 'border-emerald-200 bg-emerald-50 text-emerald-800',
            error: 'border-rose-200 bg-rose-50 text-rose-800',
            info: 'border-slate-200 bg-white text-slate-800',
          };
          const toast = document.createElement('div');
          toast.className = `pointer-events-auto rounded-xl border px-3 py-2 shadow-sm transition-opacity ${toneClass[kind] || toneClass.info}`;
          toast.innerHTML = `<p class="text-sm font-semibold">${message}</p>`;
          toastContainer.appendChild(toast);
          setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => toast.remove(), 200);
          }, 2800);
        };
        if (context.alert_message) {
          showToast(String(context.alert_message), 'success');
        }
        let activeRow = null;
        let currentQuantity = 0;
        let initialQuantity = 0;
        const updateModalVisuals = (payload) => {
          statusText.textContent = payload.status_label || '未設定';
          statusBadge.textContent = payload.status_label || '未設定';
          statusBadge.className = 'inline-flex items-center justify-center rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide ' + (payload.status_badge || '');
          lastActivityDisplay.textContent = payload.last_activity || '-';
          lastUpdatedDisplay.textContent = payload.last_updated || '-';
          const orderText = payload.order_status_display
            ? (payload.order_due_display ? `${payload.order_status_display} 納期: ${payload.order_due_display}` : payload.order_status_display)
            : '-';
          orderStatusDisplay.textContent = orderText;
        };
        const setQuantity = (value) => {
          currentQuantity = Math.max(0, value);
          quantityDisplay.textContent = formatInteger(currentQuantity);
          const reorderValue = parseIntegerValue(activeRow?.dataset.itemReorder);
          const gapValue = currentQuantity - reorderValue;
          gapDisplay.textContent = `${gapValue >= 0 ? '+' : ''}${formatInteger(gapValue)}`;
          reorderDisplay.textContent = formatInteger(reorderValue);
        };
        const applyInventoryResponse = (payload) => {
          if (!activeRow) {
            return;
          }
          const onHand = Number(payload.on_hand) || 0;
          const reorder = Number(payload.reorder_point) || 0;
          const gap = onHand - reorder;
          activeRow.dataset.itemOnHand = payload.on_hand;
          activeRow.dataset.itemReorder = payload.reorder_point;
          activeRow.dataset.itemDifference = payload.gap_label;
          activeRow.dataset.itemStatus = payload.status_label;
          activeRow.dataset.itemStatusBadge = payload.status_badge;
          activeRow.dataset.itemLastActivity = payload.last_activity;
          activeRow.dataset.itemLastUpdated = payload.last_updated;
          activeRow.dataset.itemOrderStatus = payload.order_status_display || '';
          activeRow.dataset.itemOrderDue = payload.order_due_display || '';
          activeRow.classList.remove('bg-red-50');
          if (gap <= 0) {
            activeRow.classList.add('bg-red-50');
          }
          const cells = activeRow.querySelectorAll('td');
          if (cells[3]) {
            cells[3].textContent = formatInteger(payload.on_hand);
          }
          if (cells[4]) {
            cells[4].textContent = formatInteger(payload.reorder_point);
          }
          const gapEl = activeRow.querySelector('[data-role="stock-gap"]');
          if (gapEl) {
            gapEl.textContent = payload.gap_label;
            gapEl.className = 'text-xs font-semibold ' + (gap > 0 ? 'text-emerald-600' : 'text-red-600');
          }
          const gapIconSpan = gapEl?.previousElementSibling;
          if (gapIconSpan && gapIconSpan.classList.contains('material-symbols-outlined')) {
            gapIconSpan.textContent = gap > 0 ? 'arrow_upward' : 'warning';
            gapIconSpan.className = 'material-symbols-outlined text-xs ' + (gap > 0 ? 'text-emerald-600' : 'text-red-600');
          }
          const statusEl = activeRow.querySelector('[data-role="status-badge"]');
          if (statusEl) {
            statusEl.textContent = payload.status_label;
            statusEl.className = 'status-badge inline-flex items-center justify-center rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide ' + (payload.status_badge || '');
          }
          const lastActivityElRow = activeRow.querySelector('[data-role="last-activity"]');
          const lastUpdatedElRow = activeRow.querySelector('[data-role="last-updated"]');
          const orderStatusElRow = activeRow.querySelector('[data-role="order-status"]');
          if (lastActivityElRow) {
            lastActivityElRow.textContent = payload.last_activity;
          }
          if (lastUpdatedElRow) {
            lastUpdatedElRow.textContent = payload.last_updated;
          }
          if (orderStatusElRow) {
            orderStatusElRow.textContent = payload.order_status_display
              ? (payload.order_due_display ? `${payload.order_status_display} 納期: ${payload.order_due_display}` : payload.order_status_display)
              : '-';
            orderStatusElRow.className = payload.order_status_display ? 'text-[11px] font-medium text-primary' : 'text-[11px] text-slate-400';
          }
          updateModalVisuals(payload);
          setQuantity(payload.on_hand);
        };
        const createRecentTransactionRow = (tx) => {
          const row = document.createElement('div');
          row.className = 'flex flex-col gap-2 py-3 sm:flex-row sm:items-center sm:justify-between';
          const left = document.createElement('div');
          row.appendChild(left);
          const title = document.createElement('p');
          title.className = 'text-sm font-semibold text-slate-900';
          title.textContent = tx.item || '不明品目';
          left.appendChild(title);
          const meta = document.createElement('p');
          meta.className = 'text-[11px] text-slate-500';
          meta.textContent = `${tx.date || ''}・${tx.department || ''}`;
          left.appendChild(meta);
          const detail = document.createElement('p');
          detail.className = 'text-[11px] text-slate-400';
          detail.textContent = `棚番 ${tx.shelf || '未設定'} / 品番 ${tx.item_code || '未設定'} / メーカー ${tx.manufacturer || '未設定'}`;
          left.appendChild(detail);
          if (tx.note && tx.note !== tx.summary) {
            const note = document.createElement('p');
            note.className = 'text-[11px] text-slate-400';
            note.textContent = tx.note;
            left.appendChild(note);
          }
          const right = document.createElement('div');
          right.className = 'flex flex-wrap items-center gap-3 text-xs text-slate-600';
          const badge = document.createElement('span');
          badge.className = 'rounded-full border border-slate-200 px-3 py-1';
          badge.textContent = tx.summary || '';
          right.appendChild(badge);
          const deltaItem = document.createElement('span');
          deltaItem.className = 'text-slate-900 font-bold';
          deltaItem.textContent = tx.delta || '';
          right.appendChild(deltaItem);
          if (tx.note && tx.note !== tx.summary) {
            const noteBadge = document.createElement('span');
            noteBadge.className = 'text-slate-500';
            noteBadge.textContent = tx.note;
            right.appendChild(noteBadge);
          }
          row.appendChild(right);
          return row;
        };
        const renderRecentTransactions = (transactions) => {
          if (!recentContainer) {
            return;
          }
          recentContainer.innerHTML = '';
          const fragment = document.createDocumentFragment();
          transactions.forEach((tx) => fragment.appendChild(createRecentTransactionRow(tx)));
          recentContainer.appendChild(fragment);
          if (recentCount) {
            recentCount.textContent = `直近${transactions.length}件`;
          }
        };
        const refreshRecentTransactions = async () => {
          if (!recentContainer) {
            return;
          }
          try {
            const response = await fetch('/recent-transactions');
            if (!response.ok) {
              return;
            }
            const data = await response.json();
            renderRecentTransactions(data.transactions || []);
          } catch (error) {
            console.error('recent transactions refresh failed', error);
          }
        };
        const openModal = (row) => {
          activeRow = row;
          itemNameDisplay.textContent = row.dataset.itemName || row.dataset.itemCode || '-';
          itemCodeDisplay.textContent = row.dataset.itemCode || '-';
          shelfDisplay.textContent = row.dataset.itemShelf || '未設定';
          manufacturerDisplay.textContent = row.dataset.itemManufacturer || '未設定';
          statusText.textContent = row.dataset.itemStatus || '未設定';
          statusBadge.textContent = row.dataset.itemStatus || '未設定';
          statusBadge.className = 'inline-flex items-center justify-center rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide ' + (row.dataset.itemStatusBadge || '');
          lastActivityDisplay.textContent = row.dataset.itemLastActivity || '-';
          lastUpdatedDisplay.textContent = row.dataset.itemLastUpdated || '-';
          const orderStatus = row.dataset.itemOrderStatus || '';
          const orderDue = row.dataset.itemOrderDue || '';
          orderStatusDisplay.textContent = orderStatus ? (orderDue ? `${orderStatus} 納期: ${orderDue}` : orderStatus) : '-';
          const starting = parseIntegerValue(row.dataset.itemOnHand);
          initialQuantity = starting;
          setQuantity(starting);
          modal.classList.remove('hidden');
        };
        document.querySelectorAll('tbody tr[data-item-code]').forEach((row) => {
          row.addEventListener('click', () => openModal(row));
        });
        const closeModal = () => {
          modal.classList.add('hidden');
          activeRow = null;
        };
        closeTriggers.forEach((trigger) => trigger.addEventListener('click', closeModal));
        decrementButton?.addEventListener('click', (event) => {
          event.stopPropagation();
          setQuantity(currentQuantity - 1);
        });
        incrementButton?.addEventListener('click', (event) => {
          event.stopPropagation();
          setQuantity(currentQuantity + 1);
        });
        quantityDisplay?.addEventListener('click', () => {
          setQuantity(currentQuantity + 1);
        });
        confirmButton?.addEventListener('click', async () => {
          if (!activeRow) {
            return;
          }
          confirmButton.disabled = true;
          try {
            setLoading(true, '在庫を更新しています...');
            const delta = currentQuantity - initialQuantity;
            let response;
            if (delta < 0) {
              response = await fetch('/api/inventory/issues', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  item_code: activeRow.dataset.itemCode,
                  quantity: Math.abs(delta),
                }),
              });
            } else {
              response = await fetch('/inventory/inline-adjust', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  item_code: activeRow.dataset.itemCode,
                  target_quantity: currentQuantity,
                }),
              });
            }
            if (!response.ok) {
              const error = await response.json().catch(() => null);
              throw new Error(error?.detail || '在庫の更新に失敗しました');
            }
            const payload = await response.json();
            applyInventoryResponse(payload);
            refreshRecentTransactions();
            showToast(payload.message || '在庫を更新しました。', 'success');
            closeModal();
          } catch (error) {
            showToast(error.message || String(error), 'error');
          } finally {
            setLoading(false);
            confirmButton.disabled = false;
          }
        });
      });
    </script>
  </div>
</body>
</html>
