<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>購入品データ管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script id="tailwind-config">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#1152d4",
            "primary-dark": "#0e3c9a",
          },
          fontFamily: {
            display: ["Noto Sans JP", "Inter", "sans-serif"],
          },
        },
      },
    };
  </script>
  <style>
    body {
      font-family: "Noto Sans JP", "Inter", sans-serif;
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">
  <header class="sticky top-0 z-30 bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-screen-xl mx-auto flex flex-col gap-3 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs text-slate-500 uppercase tracking-[0.3em]">データ管理</p>
        <p class="text-2xl font-bold text-slate-900">仕入品・仕入先</p>
      </div>
      <div class="flex items-center gap-4 text-xs text-slate-500 sm:gap-6">
        <span class="material-symbols-outlined text-base">notifications</span>
        <span>更新: {{ now.strftime('%Y/%m/%d %H:%M') }}</span>
      </div>
    </div>
    <div class="border-t border-slate-100">
      <div class="max-w-screen-xl mx-auto flex flex-wrap items-center gap-4 px-4 py-2 text-xs uppercase tracking-[0.3em]">
        {% for link in nav_links %}
        <a href="{{ link.href }}" class="py-2 {% if link.right %}ml-auto {% endif %}{% if link.active %}text-primary border-b-2 border-primary{% else %}text-slate-500 hover:text-slate-900{% endif %}">
          {{ link.label }}
        </a>
        {% endfor %}
      </div>
    </div>
  </header>
  <main class="max-w-screen-xl mx-auto px-4 py-6 space-y-6">
    <section class="grid gap-4 lg:grid-cols-2">
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500">仕入先</p>
          <h2 class="text-lg font-semibold text-slate-900">仕入先を追加／編集</h2>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs text-slate-400">仕入先検索</label>
          <input id="supplier-search" list="supplier-suggestions" type="search" placeholder="仕入先名で絞り込む" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
          <datalist id="supplier-suggestions">
            {% for supplier in suppliers %}
            <option value="{{ supplier.name }}">{{ supplier.contact_person or '' }}</option>
            {% endfor %}
          </datalist>
        </div>
        <form id="supplier-form" class="space-y-3">
          <input type="hidden" id="supplier-id" name="supplier_id" value="" />
          <label class="flex flex-col gap-1 text-sm text-slate-600">
            <span class="text-xs text-slate-500">仕入先名</span>
            <input id="supplier-name" name="name" type="text" required class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
          </label>
          <label class="flex flex-col gap-1 text-sm text-slate-600">
            <span class="text-xs text-slate-500">担当者</span>
            <input id="supplier-contact" name="contact_person" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
          </label>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">携帯</span>
              <input id="supplier-mobile" name="mobile_number" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">電話</span>
              <input id="supplier-phone" name="phone_number" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">メール</span>
              <input id="supplier-email" name="email" type="email" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">FAX</span>
              <input id="supplier-fax" name="fax_number" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">アシスタント名</span>
              <input id="supplier-assistant-name" name="assistant_name" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">アシスタントメール</span>
              <input id="supplier-assistant-email" name="assistant_email" type="email" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm text-slate-600">
            <span class="text-xs text-slate-500">備考</span>
            <input id="supplier-notes" name="notes" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
          </label>
          <div class="flex items-center gap-2">
            <button type="submit" class="flex-1 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark">
              保存
            </button>
            <button type="button" id="supplier-form-reset" class="rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:border-slate-300">
              新規
            </button>
          </div>
        </form>
        <div id="supplier-list" class="space-y-2">
          {% for supplier in suppliers %}
          <div class="px-4 py-3 rounded-2xl border border-slate-100 bg-slate-50 cursor-pointer supplier-row transition hover:bg-slate-100"
               data-id="{{ supplier.id }}"
               data-name="{{ supplier.name }}"
               data-contact="{{ supplier.contact_person or '' }}"
               data-mobile="{{ supplier.mobile_number or '' }}"
               data-phone="{{ supplier.phone_number or '' }}"
               data-email="{{ supplier.email or '' }}"
               data-assistant-name="{{ supplier.assistant_name or '' }}"
               data-assistant-email="{{ supplier.assistant_email or '' }}"
               data-fax="{{ supplier.fax_number or '' }}"
               data-notes="{{ supplier.notes or '' }}">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-900">{{ supplier.name }}</p>
              <span class="text-[10px] text-slate-500">ID {{ supplier.id }}</span>
            </div>
            <p class="text-[11px] text-slate-500">担当: {{ supplier.contact_person or '未設定' }} / Tel: {{ supplier.phone_number or '－' }}</p>
            <p class="text-[11px] text-slate-500">Mobile: {{ supplier.mobile_number or '－' }} / Fax: {{ supplier.fax_number or '－' }}</p>
            <p class="text-[11px] text-slate-500">Mail: {{ supplier.email or '－' }} / アシスタント: {{ supplier.assistant_name or '－' }} / {{ supplier.assistant_email or '－' }}</p>
            <p class="text-[11px] text-slate-400">備考: {{ supplier.notes or '－' }}</p>
          </div>
          {% endfor %}
        </div>
      </article>
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500">仕入品</p>
          <h2 class="text-lg font-semibold text-slate-900">仕入品を追加／編集</h2>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs text-slate-400">仕入品検索</label>
          <div class="flex gap-2">
            <input id="item-search-input" list="item-suggestions" type="search" placeholder="品番・品名などで検索" class="flex-1 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            <datalist id="item-suggestions">
              {% for item in items %}
              <option value="{{ item.item_code }} - {{ item.name }}"></option>
              {% endfor %}
            </datalist>
            <button type="button" id="item-search-button" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-dark">
              検索
            </button>
          </div>
        </div>
        <form id="item-form" class="space-y-3">
          <input type="hidden" id="item-id" name="item_id" value="" />
          <label class="flex flex-col gap-1 text-sm text-slate-600">
            <span class="text-xs text-slate-500">品番</span>
            <input id="item-code" name="item_code" type="text" required class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
          </label>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">カテゴリ（種類）</span>
              <input id="item-type" name="item_type" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">用途</span>
              <input id="item-usage" name="usage" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">部署</span>
              <input id="item-department" name="department" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">メーカー</span>
              <input id="item-manufacturer" name="manufacturer" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">棚番</span>
              <input id="item-shelf" name="shelf" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">管理／管理外</span>
              <select id="item-management-type" name="management_type" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                <option value="管理">管理</option>
                <option value="管理外">管理外</option>
              </select>
            </label>
          </div>
          <div class="grid gap-2 md:grid-cols-2 items-end">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">発注点</span>
              <input id="item-reorder" name="reorder_point" type="number" min="0" value="0" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs text-slate-500">仕入先</span>
              <select id="item-supplier" name="supplier_id" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                <option value="">未選択</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <button type="submit" class="flex-1 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark">
              保存
            </button>
            <button type="button" id="item-form-reset" class="rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:border-slate-300">
              新規
            </button>
          </div>
        </form>
        <div id="item-list" class="space-y-2">
          <!-- 項目はJSでレンダリング -->
        </div>
      </article>
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">メール設定</p>
        <h2 class="text-lg font-semibold text-slate-900">SMTP・送信アカウント（管理者）</h2>
      </div>

      <div class="grid gap-3 md:grid-cols-2">
        <label class="flex flex-col gap-1 text-sm text-slate-600">
          <span class="text-xs text-slate-500">SMTPサーバー</span>
          <input id="mail-settings-smtp-server" type="text" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
        </label>
        <label class="flex flex-col gap-1 text-sm text-slate-600">
          <span class="text-xs text-slate-500">SMTPポート</span>
          <input id="mail-settings-smtp-port" type="number" min="1" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm" />
        </label>
      </div>

      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-slate-700">送信アカウント</h3>
        <button type="button" id="add-mail-account" class="rounded-xl border border-slate-300 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50">追加</button>
      </div>
      <div class="overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
            <tr>
              <th class="px-3 py-2 text-left">キー</th>
              <th class="px-3 py-2 text-left">表示名</th>
              <th class="px-3 py-2 text-left">送信元メール</th>
              <th class="px-3 py-2 text-left">部署</th>
              <th class="px-3 py-2 text-left">パスワード</th>
              <th class="px-3 py-2 text-left">操作</th>
            </tr>
          </thead>
          <tbody id="mail-accounts-body" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-slate-700">部署デフォルト担当</h3>
        <button type="button" id="add-department-default" class="rounded-xl border border-slate-300 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50">追加</button>
      </div>
      <div class="overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
            <tr>
              <th class="px-3 py-2 text-left">部署</th>
              <th class="px-3 py-2 text-left">デフォルトアカウント</th>
              <th class="px-3 py-2 text-left">操作</th>
            </tr>
          </thead>
          <tbody id="department-defaults-body" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>

      <div class="flex justify-end">
        <button type="button" id="save-mail-settings" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-dark">メール設定を保存</button>
      </div>
      <p class="text-xs text-slate-500">※ この画面は管理者向けです。保存後は発注画面の担当者選択にも即時反映されます。</p>
    </section>
  </main>
  <div id="global-loading" class="hidden fixed inset-0 z-[70] items-center justify-center bg-slate-900/40">
    <div class="rounded-2xl bg-white px-6 py-5 shadow-2xl border border-slate-200 min-w-[260px]">
      <div class="flex items-center gap-3">
        <div class="h-6 w-6 rounded-full border-2 border-slate-200 border-t-primary animate-spin"></div>
        <div>
          <p class="text-sm font-semibold text-slate-800">処理中</p>
          <p id="global-loading-message" class="text-xs text-slate-500">しばらくお待ちください...</p>
        </div>
      </div>
    </div>
  </div>
  <div id="toast-container" class="pointer-events-none fixed right-4 top-4 z-[80] flex w-[340px] max-w-[calc(100vw-2rem)] flex-col gap-2"></div>
  <script id="initial-items-data" type="application/json">
    {{ items_data | tojson | safe }}
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const supplierForm = document.getElementById('supplier-form');
      const supplierIdInput = document.getElementById('supplier-id');
      const supplierNameInput = document.getElementById('supplier-name');
      const supplierContactInput = document.getElementById('supplier-contact');
      const supplierMobileInput = document.getElementById('supplier-mobile');
      const supplierPhoneInput = document.getElementById('supplier-phone');
      const supplierEmailInput = document.getElementById('supplier-email');
      const supplierFaxInput = document.getElementById('supplier-fax');
      const supplierAssistantNameInput = document.getElementById('supplier-assistant-name');
      const supplierAssistantEmailInput = document.getElementById('supplier-assistant-email');
      const supplierNotesInput = document.getElementById('supplier-notes');
      const supplierReset = document.getElementById('supplier-form-reset');
      const supplierSearch = document.getElementById('supplier-search');
      let supplierRows = Array.from(document.querySelectorAll('.supplier-row'));

      const smtpServerInput = document.getElementById('mail-settings-smtp-server');
      const smtpPortInput = document.getElementById('mail-settings-smtp-port');
      const mailAccountsBody = document.getElementById('mail-accounts-body');
      const departmentDefaultsBody = document.getElementById('department-defaults-body');
      const addMailAccountButton = document.getElementById('add-mail-account');
      const addDepartmentDefaultButton = document.getElementById('add-department-default');
      const saveMailSettingsButton = document.getElementById('save-mail-settings');
      const loadingOverlay = document.getElementById('global-loading');
      const loadingMessage = document.getElementById('global-loading-message');
      const toastContainer = document.getElementById('toast-container');
      let mailSettingsState = {
        smtp_server: '',
        smtp_port: 587,
        accounts: {},
        department_defaults: {},
        password_registered: {},
        keyring_available: true,
      };

      const setLoading = (isLoading, message = 'しばらくお待ちください...') => {
        if (!loadingOverlay || !loadingMessage) {
          return;
        }
        loadingMessage.textContent = message;
        if (isLoading) {
          loadingOverlay.classList.remove('hidden');
          loadingOverlay.classList.add('flex');
          return;
        }
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
      };

      const showToast = (message, kind = 'info') => {
        if (!toastContainer) {
          return;
        }
        const toneClass = {
          success: 'border-emerald-200 bg-emerald-50 text-emerald-800',
          error: 'border-rose-200 bg-rose-50 text-rose-800',
          info: 'border-slate-200 bg-white text-slate-800',
        };
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto rounded-xl border px-3 py-2 shadow-sm transition-opacity ${toneClass[kind] || toneClass.info}`;
        toast.innerHTML = `<p class="text-sm font-semibold">${String(message || '')}</p>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0');
          setTimeout(() => toast.remove(), 200);
        }, 2800);
      };

      const originalFetch = window.fetch.bind(window);
      let pendingRequests = 0;
      window.fetch = async (...args) => {
        pendingRequests += 1;
        setLoading(true);
        try {
          return await originalFetch(...args);
        } finally {
          pendingRequests = Math.max(0, pendingRequests - 1);
          if (pendingRequests === 0) {
            setLoading(false);
          }
        }
      };

      const itemForm = document.getElementById('item-form');
      const itemIdInput = document.getElementById('item-id');
      const itemCodeInput = document.getElementById('item-code');
      const itemTypeInput = document.getElementById('item-type');
      const itemUsageInput = document.getElementById('item-usage');
      const itemDepartmentInput = document.getElementById('item-department');
      const itemManufacturerInput = document.getElementById('item-manufacturer');
      const itemShelfInput = document.getElementById('item-shelf');
      const itemReorderInput = document.getElementById('item-reorder');
      const itemManagementTypeSelect = document.getElementById('item-management-type');
      const itemSupplierSelect = document.getElementById('item-supplier');
      const itemReset = document.getElementById('item-form-reset');
      const itemList = document.getElementById('item-list');
      const itemSearchInput = document.getElementById('item-search-input');
      const itemSearchButton = document.getElementById('item-search-button');

      const initialItemsElement = document.getElementById('initial-items-data');
      const initialItems = initialItemsElement
        ? JSON.parse(initialItemsElement.textContent || '[]')
        : [];

      let supplierEditPrevious = null; // 編集時の変更内容表示用（クリック時の値）
      const resetSupplierForm = () => {
        supplierIdInput.value = '';
        supplierNameInput.value = '';
        supplierContactInput.value = '';
        supplierMobileInput.value = '';
        supplierPhoneInput.value = '';
        supplierEmailInput.value = '';
        supplierFaxInput.value = '';
        supplierAssistantNameInput.value = '';
        supplierAssistantEmailInput.value = '';
        supplierNotesInput.value = '';
        supplierEditPrevious = null;
      };
      const resetItemForm = () => {
        itemIdInput.value = '';
        itemCodeInput.value = '';
        itemTypeInput.value = '';
        itemUsageInput.value = '';
        itemDepartmentInput.value = '';
        itemManufacturerInput.value = '';
        itemShelfInput.value = '';
        itemReorderInput.value = '0';
        if (itemManagementTypeSelect) itemManagementTypeSelect.value = '管理';
        itemSupplierSelect.value = '';
        itemEditPreviousReorder = null;
      };

      const bindSupplierRows = () => {
        supplierRows.forEach((row) => {
          row.addEventListener('click', () => {
            supplierIdInput.value = row.dataset.id || '';
            supplierNameInput.value = row.dataset.name || '';
            supplierContactInput.value = row.dataset.contact || '';
            supplierMobileInput.value = row.dataset.mobile || '';
            supplierPhoneInput.value = row.dataset.phone || '';
            supplierEmailInput.value = row.dataset.email || '';
            supplierFaxInput.value = row.dataset.fax || '';
            supplierAssistantNameInput.value = row.dataset.assistantName || '';
            supplierAssistantEmailInput.value = row.dataset.assistantEmail || '';
            supplierNotesInput.value = row.dataset.notes || '';
            supplierEditPrevious = {
              name: (row.dataset.name || '').trim(),
              contact_person: (row.dataset.contact || '').trim(),
              mobile_number: (row.dataset.mobile || '').trim(),
              phone_number: (row.dataset.phone || '').trim(),
              email: (row.dataset.email || '').trim(),
              fax_number: (row.dataset.fax || '').trim(),
              assistant_name: (row.dataset.assistantName || '').trim(),
              assistant_email: (row.dataset.assistantEmail || '').trim(),
              notes: (row.dataset.notes || '').trim(),
            };
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        });
      };

      const filterSuppliers = (query) => {
        const normalized = query.trim().toLowerCase();
        supplierRows.forEach((row) => {
          const name = (row.dataset.name || '').toLowerCase();
          row.style.display = normalized && !name.includes(normalized) ? 'none' : '';
        });
      };

      const createItemRow = (item) => {
        const row = document.createElement('div');
        row.className = 'px-4 py-3 rounded-2xl border border-slate-100 bg-slate-50 cursor-pointer item-row transition hover:bg-slate-100';
        row.dataset.id = item.id;
        row.dataset.code = item.item_code;
        row.dataset.name = item.name;
        row.dataset.type = item.item_type || '';
        row.dataset.usage = item.usage || '';
        row.dataset.department = item.department || '';
        row.dataset.manufacturer = item.manufacturer || '';
        row.dataset.shelf = item.shelf || '';
        row.dataset.unit = item.unit || '';
        row.dataset.reorder = item.reorder_point ?? 0;
        row.dataset.managementType = item.management_type || '管理';
        row.dataset.supplier = item.supplier_id || '';
        row.dataset.supplierName = item.supplier_name || '';
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-slate-900">${item.item_code} - ${item.name}</p>
            <span class="text-[10px] text-slate-500">ID ${item.id}</span>
          </div>
          <p class="text-[11px] text-slate-500">
            ${item.item_type || '種類未設定'} / ${item.usage || '用途未設定'}
          </p>
          <p class="text-[11px] text-slate-400">
            棚番 ${item.shelf || '未設定'} / 部署 ${item.department || '未設定'} / 仕入先 ${item.supplier_name || '未設定'}
          </p>
        `;
        return row;
      };

      let currentItemRows = [];
      let itemEditPreviousReorder = null; // 編集時の完了メッセージ用（変更前の発注点）
      const bindItemRowListeners = () => {
        currentItemRows = Array.from(document.querySelectorAll('.item-row'));
        currentItemRows.forEach((row) => {
          row.addEventListener('click', () => {
            itemIdInput.value = row.dataset.id || '';
            itemCodeInput.value = row.dataset.code || '';
            itemTypeInput.value = row.dataset.type || '';
            itemUsageInput.value = row.dataset.usage || '';
            itemDepartmentInput.value = row.dataset.department || '';
            itemManufacturerInput.value = row.dataset.manufacturer || '';
            itemShelfInput.value = row.dataset.shelf || '';
            itemReorderInput.value = row.dataset.reorder || '0';
            if (itemManagementTypeSelect) itemManagementTypeSelect.value = (row.dataset.managementType || '管理') === '管理外' ? '管理外' : '管理';
            itemSupplierSelect.value = row.dataset.supplier || '';
            itemEditPreviousReorder = row.dataset.reorder ?? '0';
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        });
      };

      const renderItemList = (items) => {
        if (!itemList) {
          return;
        }
        itemList.innerHTML = '';
        const fragment = document.createDocumentFragment();
        items.forEach((item) => fragment.appendChild(createItemRow(item)));
        itemList.appendChild(fragment);
        bindItemRowListeners();
      };

      const normalizeAccountKey = (value) => {
        return String(value || '')
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9_-]/g, '_');
      };

      const accountOptionsHtml = (selectedValue = '') => {
        const keys = Object.keys(mailSettingsState.accounts || {}).sort();
        const options = ['<option value="">選択してください</option>'];
        keys.forEach((key) => {
          const account = mailSettingsState.accounts[key] || {};
          const selected = key === selectedValue ? ' selected' : '';
          const label = `${key} (${account.display_name || '-'})`;
          options.push(`<option value="${key}"${selected}>${label}</option>`);
        });
        return options.join('');
      };

      const renderMailAccounts = () => {
        if (!mailAccountsBody) {
          return;
        }
        const accounts = mailSettingsState.accounts || {};
        const passwordRegistered = mailSettingsState.password_registered || {};
        const rows = Object.keys(accounts)
          .sort()
          .map((key) => {
            const account = accounts[key] || {};
            const passwordStatus = passwordRegistered[key]
              ? '<span class="rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-[10px] text-emerald-700">登録済み</span>'
              : '<span class="rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[10px] text-slate-500">未登録</span>';
            return `
              <tr data-account-key="${key}">
                <td class="px-3 py-2"><input type="text" class="mail-account-key w-full rounded border border-slate-300 px-2 py-1 text-xs" value="${key}" /></td>
                <td class="px-3 py-2"><input type="text" class="mail-account-display w-full rounded border border-slate-300 px-2 py-1 text-xs" value="${account.display_name || ''}" /></td>
                <td class="px-3 py-2"><input type="email" class="mail-account-sender w-full rounded border border-slate-300 px-2 py-1 text-xs" value="${account.sender || ''}" /></td>
                <td class="px-3 py-2"><input type="text" class="mail-account-department w-full rounded border border-slate-300 px-2 py-1 text-xs" value="${account.department || ''}" /></td>
                <td class="px-3 py-2">
                  <div class="flex items-center gap-2">
                    <input type="password" class="mail-account-password w-full rounded border border-slate-300 px-2 py-1 text-xs" placeholder="パスワード" />
                    <button type="button" class="mail-account-save-password rounded border border-slate-300 px-2 py-1 text-xs">設定</button>
                    ${passwordStatus}
                  </div>
                </td>
                <td class="px-3 py-2">
                  <button type="button" class="mail-account-remove rounded border border-rose-200 px-2 py-1 text-xs text-rose-700">削除</button>
                </td>
              </tr>
            `;
          });
        mailAccountsBody.innerHTML = rows.join('');
      };

      const renderDepartmentDefaults = () => {
        if (!departmentDefaultsBody) {
          return;
        }
        const defaults = mailSettingsState.department_defaults || {};
        const departments = Object.keys(defaults).sort();
        const rows = departments.map((department) => {
          const accountKey = defaults[department] || '';
          return `
            <tr data-department="${department}">
              <td class="px-3 py-2"><input type="text" class="mail-default-department w-full rounded border border-slate-300 px-2 py-1 text-xs" value="${department}" /></td>
              <td class="px-3 py-2">
                <select class="mail-default-account w-full rounded border border-slate-300 px-2 py-1 text-xs">
                  ${accountOptionsHtml(accountKey)}
                </select>
              </td>
              <td class="px-3 py-2">
                <button type="button" class="mail-default-remove rounded border border-rose-200 px-2 py-1 text-xs text-rose-700">削除</button>
              </td>
            </tr>
          `;
        });
        departmentDefaultsBody.innerHTML = rows.join('');
      };

      const renderMailSettings = () => {
        if (smtpServerInput) smtpServerInput.value = mailSettingsState.smtp_server || '';
        if (smtpPortInput) smtpPortInput.value = String(mailSettingsState.smtp_port || 587);
        renderMailAccounts();
        renderDepartmentDefaults();
      };

      const loadMailSettings = async () => {
        try {
          const response = await fetch('/api/email-settings');
          if (!response.ok) {
            throw new Error('メール設定の読み込みに失敗しました。');
          }
          const payload = await response.json();
          mailSettingsState = {
            smtp_server: payload.smtp_server || '',
            smtp_port: Number(payload.smtp_port || 587),
            accounts: payload.accounts || {},
            department_defaults: payload.department_defaults || {},
            password_registered: payload.password_registered || {},
            keyring_available: payload.keyring_available !== false,
          };
          renderMailSettings();
        } catch (error) {
          showToast(error.message || String(error));
        }
      };

      const collectMailSettingsPayload = () => {
        const accounts = {};
        const defaults = {};
        const accountRows = Array.from(document.querySelectorAll('#mail-accounts-body tr'));
        for (const row of accountRows) {
          const rawKey = row.querySelector('.mail-account-key')?.value || '';
          const key = normalizeAccountKey(rawKey);
          const displayName = (row.querySelector('.mail-account-display')?.value || '').trim();
          const sender = (row.querySelector('.mail-account-sender')?.value || '').trim();
          const department = (row.querySelector('.mail-account-department')?.value || '').trim();
          if (!key && !displayName && !sender && !department) {
            continue;
          }
          if (!key) {
            throw new Error('アカウントキーを入力してください。');
          }
          if (accounts[key]) {
            throw new Error(`アカウントキーが重複しています: ${key}`);
          }
          if (!displayName || !sender) {
            throw new Error(`アカウント ${key} は表示名と送信元メールが必須です。`);
          }
          accounts[key] = {
            display_name: displayName,
            sender,
            department,
          };
        }

        const defaultRows = Array.from(document.querySelectorAll('#department-defaults-body tr'));
        for (const row of defaultRows) {
          const department = (row.querySelector('.mail-default-department')?.value || '').trim();
          const accountKey = (row.querySelector('.mail-default-account')?.value || '').trim();
          if (!department && !accountKey) {
            continue;
          }
          if (!department || !accountKey) {
            throw new Error('部署デフォルトは部署とアカウントを両方指定してください。');
          }
          if (!accounts[accountKey]) {
            throw new Error(`部署デフォルトのアカウントが存在しません: ${accountKey}`);
          }
          defaults[department] = accountKey;
        }

        return {
          smtp_server: (smtpServerInput?.value || '').trim(),
          smtp_port: Number(smtpPortInput?.value || 0),
          accounts,
          department_defaults: defaults,
        };
      };

      const syncMailStateFromInputs = () => {
        const payload = collectMailSettingsPayload();
        mailSettingsState = {
          ...mailSettingsState,
          ...payload,
        };
      };

      addMailAccountButton?.addEventListener('click', () => {
        try {
          syncMailStateFromInputs();
          let index = 1;
          let newKey = `new_account_${index}`;
          while (mailSettingsState.accounts[newKey]) {
            index += 1;
            newKey = `new_account_${index}`;
          }
          mailSettingsState.accounts[newKey] = {
            display_name: '',
            sender: '',
            department: '',
          };
          renderMailSettings();
        } catch (error) {
          showToast(error.message || String(error));
        }
      });

      addDepartmentDefaultButton?.addEventListener('click', () => {
        try {
          syncMailStateFromInputs();
          let index = 1;
          let department = `新規部署${index}`;
          while (mailSettingsState.department_defaults[department]) {
            index += 1;
            department = `新規部署${index}`;
          }
          mailSettingsState.department_defaults[department] = '';
          renderDepartmentDefaults();
        } catch (error) {
          showToast(error.message || String(error));
        }
      });

      mailAccountsBody?.addEventListener('click', async (event) => {
        const removeButton = event.target.closest('.mail-account-remove');
        if (removeButton) {
          try {
            syncMailStateFromInputs();
            const row = removeButton.closest('tr');
            const rawKey = row?.querySelector('.mail-account-key')?.value || '';
            const accountKey = normalizeAccountKey(rawKey);
            if (!accountKey) {
              row?.remove();
              return;
            }
            delete mailSettingsState.accounts[accountKey];
            delete mailSettingsState.password_registered[accountKey];
            Object.keys(mailSettingsState.department_defaults).forEach((department) => {
              if (mailSettingsState.department_defaults[department] === accountKey) {
                delete mailSettingsState.department_defaults[department];
              }
            });
            renderMailSettings();
          } catch (error) {
            showToast(error.message || String(error));
          }
          return;
        }

        const savePasswordButton = event.target.closest('.mail-account-save-password');
        if (savePasswordButton) {
          if (!mailSettingsState.keyring_available) {
            showToast('keyring が利用できないため、パスワードを保存できません。');
            return;
          }
          const row = savePasswordButton.closest('tr');
          const rawKey = row?.querySelector('.mail-account-key')?.value || '';
          const accountKey = normalizeAccountKey(rawKey);
          const passwordInput = row?.querySelector('.mail-account-password');
          const password = (passwordInput?.value || '').trim();
          if (!accountKey) {
            showToast('アカウントキーが不正です。');
            return;
          }
          if (!password) {
            showToast('パスワードを入力してください。');
            return;
          }
          try {
            const response = await fetch(`/api/email-settings/accounts/${encodeURIComponent(accountKey)}/password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password }),
            });
            const result = await response.json().catch(() => ({}));
            if (!response.ok) {
              throw new Error(result.detail || 'パスワード保存に失敗しました。');
            }
            if (passwordInput) passwordInput.value = '';
            mailSettingsState.password_registered[accountKey] = true;
            renderMailAccounts();
            renderDepartmentDefaults();
            showToast('パスワードを保存しました。');
          } catch (error) {
            showToast(error.message || String(error));
          }
        }
      });

      departmentDefaultsBody?.addEventListener('click', (event) => {
        const removeButton = event.target.closest('.mail-default-remove');
        if (!removeButton) {
          return;
        }
        try {
          syncMailStateFromInputs();
          const row = removeButton.closest('tr');
          const department = (row?.querySelector('.mail-default-department')?.value || '').trim();
          if (department) {
            delete mailSettingsState.department_defaults[department];
          }
          row?.remove();
        } catch (error) {
          showToast(error.message || String(error));
        }
      });

      saveMailSettingsButton?.addEventListener('click', async () => {
        try {
          const payload = collectMailSettingsPayload();
          const response = await fetch('/api/email-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const result = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(result.detail || 'メール設定の保存に失敗しました。');
          }
          mailSettingsState = {
            ...mailSettingsState,
            ...payload,
          };
          await loadMailSettings();
          showToast('メール設定を保存しました。');
        } catch (error) {
          showToast(error.message || String(error));
        }
      });

      const fetchItems = async (query = '') => {
        if (!itemList) {
          return;
        }
        const params = new URLSearchParams();
        if (query) {
          params.append('q', query);
        }
        try {
          const response = await fetch(`/api/items?${params.toString()}`);
          if (!response.ok) {
            return;
          }
          const data = await response.json();
          const items = data.items || [];
          renderItemList(items);
          const firstCard = itemList.querySelector('.item-row');
          if (firstCard && items.length > 0) {
            firstCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } catch (error) {
          console.error('検索に失敗しました', error);
        }
      };

      renderItemList(initialItems);

      supplierSearch?.addEventListener('input', (event) => {
        filterSuppliers(event.target.value);
      });

      supplierForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          name: supplierNameInput.value.trim(),
          contact_person: supplierContactInput.value.trim(),
          mobile_number: supplierMobileInput.value.trim(),
          phone_number: supplierPhoneInput.value.trim(),
          email: supplierEmailInput.value.trim(),
          fax_number: supplierFaxInput.value.trim(),
          assistant_name: supplierAssistantNameInput.value.trim(),
          assistant_email: supplierAssistantEmailInput.value.trim(),
          notes: supplierNotesInput.value.trim(),
        };
        if (!payload.name) {
          showToast('仕入先名は必須です。');
          return;
        }
        const id = supplierIdInput.value.trim();
        const url = id ? `/api/suppliers/${id}` : '/api/suppliers';
        const method = id ? 'PUT' : 'POST';
        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const error = await response.json().catch(() => null);
            throw new Error(error?.detail || '仕入先の保存に失敗しました。');
          }
          let msg = id ? `仕入先名「${payload.name}」編集完了` : `仕入先名「${payload.name}」追加完了`;
          if (id && supplierEditPrevious) {
            const labels = {
              name: '仕入先名',
              contact_person: '担当者',
              mobile_number: '携帯',
              phone_number: '電話',
              email: 'メール',
              fax_number: 'FAX',
              assistant_name: 'アシスタント名',
              assistant_email: 'アシスタントメール',
              notes: '備考',
            };
            const changed = [];
            Object.keys(labels).forEach((key) => {
              const prev = (supplierEditPrevious[key] || '').trim();
              const next = (payload[key] || '').trim();
              if (prev !== next) changed.push(labels[key]);
            });
            if (changed.length > 0) {
              msg += `（${changed.join('、')}を変更）`;
            }
          }
          showToast(msg);
          resetSupplierForm();
          location.reload();
        } catch (error) {
          showToast(error.message);
        }
      });

      itemForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          item_code: itemCodeInput.value.trim(),
          name: itemCodeInput.value.trim() || itemTypeInput.value.trim() || '',
          item_type: itemTypeInput.value.trim(),
          usage: itemUsageInput.value.trim(),
          department: itemDepartmentInput.value.trim(),
          manufacturer: itemManufacturerInput.value.trim(),
          shelf: itemShelfInput.value.trim(),
          reorder_point: Number(itemReorderInput.value) || 0,
          management_type: (itemManagementTypeSelect && itemManagementTypeSelect.value) || '管理',
          supplier_id: itemSupplierSelect.value ? Number(itemSupplierSelect.value) : null,
        };
        if (!payload.item_code) {
          showToast('品番は必須です。');
          return;
        }
        const id = itemIdInput.value.trim();
        const url = id ? `/api/items/${id}` : '/api/items';
        const method = id ? 'PUT' : 'POST';
        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const error = await response.json().catch(() => null);
            throw new Error(error?.detail || '仕入品の保存に失敗しました。');
          }
          const code = payload.item_code;
          const oldR = itemEditPreviousReorder != null ? String(itemEditPreviousReorder) : null;
          const newR = String(payload.reorder_point);
          const msg = id
            ? (oldR != null && (oldR !== newR) ? `品番${code} 発注点${oldR}→${newR}へ変更完了` : `品番${code} 編集完了`)
            : `品番${code} 追加完了`;
          showToast(msg);
          resetItemForm();
          location.reload();
        } catch (error) {
          showToast(error.message);
        }
      });

      itemSearchButton?.addEventListener('click', () => {
        fetchItems(itemSearchInput?.value || '');
      });

      itemSearchInput?.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
          fetchItems(itemSearchInput.value || '');
        }
      });

      supplierReset?.addEventListener('click', resetSupplierForm);
      itemReset?.addEventListener('click', resetItemForm);
      bindSupplierRows();
      loadMailSettings();
    });
  </script>
</body>
</html>

