# Changelog

## [0.5.0] - 2026-02-13
### Added
- 入出庫管理・入庫待ち発注：納入日・伝票番号を入力必須に。API・サービス層で未入力時は 400 とメッセージを返す。フロントでは送信前にバリデーションとトースト表示。
- 入庫待ち発注の分納説明をページ上部に集約（「今回届いた分だけ…」「全品目が揃って…」）。リスト毎の重複説明を削除。
- 購入実績一覧・CSV：表記を「納品書番号」から「伝票番号」に統一。
- 用途ツリー・発注管理の部署絞り込みで全部署を表示。`usage_order.yaml`・`email_settings.json` の部署と在庫に登場する部署をマージし、在庫のない部署も表示（用途は usage_order または件数 0）。
- 仕入品削除可否 API（`GET /api/items/{item_id}/can-delete`）を追加。発注明細に紐づく場合は理由と件数を返す。
- 仕入品の「紐づきを外して削除」：発注明細に紐づくテストデータを削除するため、`DELETE /api/items/{id}?unlink_order_lines=true` で発注明細・購入実績・管理外依頼の参照を外し、単価履歴を削除してから品目を削除。データ管理画面で削除不可時に「紐づきを外して削除」の確認ダイアログを表示。

### Changed
- 購入実績一覧：納入日・購入月を編集不可に（表示のみ。API でも更新しない）。
- 購入実績一覧・入庫計上：購入者を「部署名なしのフルネーム」で統一。表示は 3 語以上のとき先頭を部署名とみなし除去。入庫計上時はフルネームで購入実績に記録。
- データ管理の削除確認モーダル：表示を `display` のインライン制御に統一し、常に画面中央に表示。実行／削除ボタンを標準 Tailwind 色（青・赤）とインラインスタイルで表示し、見えない不具合を解消。削除時はボタンラベルを「削除」に変更。
- 仕入品削除時、発注明細に紐づく場合はエラーメッセージに「テストデータの場合は『紐づきを外して削除』を利用できます」を追記。

### Fixed
- 削除確認モーダルが 2 回目以降に右上に寄ってしまう問題を修正（閉じる際に `flex` を外していたため。表示制御を `display` のみに変更）。

## [0.4.0] - 2026-02-12
### Added
- 在庫一覧の「最終取引」列に発注状況（発注依頼済／入荷待ち）と納期を表示。仕入先名は非表示に変更。
- 注文書PDFの備考欄で URL をクリック可能なリンクとして出力（`http://` / `https://` を `<a>` に変換）。
- 履歴全削除スクリプト `scripts/clear_all_history.py` を追加。発注・発注明細・注文書・メールログ・在庫取引を一括削除可能。`--yes` で確認なし実行。
- 仕入品データベースに単価（`unit_price`）を追加。仕入品の新規登録・編集フォームに単価（円）を追加（仕入先の下に配置）。一覧ではカンマ区切り（例: 1,000）で表示。
- 発注管理の候補テーブルに単価列・金額列を追加。注文数量の変更に応じて金額をリアルタイムで再計算・表示。1 品番を複数仕入先で扱う場合、仕入先を単価の安い順に並べデフォルトを最安に。単価登録が 2 社以上ある場合に「比較: 仕入先A 〇円 / 仕入先B 〇円」を表示（単価未登録の仕入先は非表示・1 行でコンパクトに表示）。比較表示の仕入先名をクリックするとその行の仕入先ドロップダウンに即反映。
- 購入品・仕入先一元管理の実装案を `docs/implementation_plan_purchase_asset_management.md` に追加（同品番複数仕入先・購入実績テーブル・入庫拡張案などを記載）。
- ナビに「購入品管理」を追加（入出庫管理とデータ管理の間）。購入品管理を単独ページ `/purchase-results` で提供し、UI は入出庫管理など他画面と統一。旧 URL `/manage/purchase-results` は `/purchase-results` へリダイレクト。
- 購入実績一覧で各項目（納入日・購入先・納品書番号・数量・単価・金額・購入月・科目名・費目名・購入者・備考）を編集可能に。行ごとの保存ボタンで PATCH `/api/purchase-results/{id}` により保存。品番・品名は表示のみ。
- 発注メール送信後の DB 保存に関するトラブルシューティングを `docs/send_email_db_save_troubleshooting.md` に追加。品番×仕入先・購入実績の保存フローを `docs/purchase_result_supplier_item_flow.md` に追加。

### Changed
- 在庫一覧から「種類」ドロップダウンを削除。カテゴリは下段のボタン（すべて／前挽き／裏挽き等）のみで選択。絞り込み送信時は hidden で現在のカテゴリを維持。
- 在庫一覧から KPI カード（管理品目数・注意対象・在庫不足・本日入荷予定）を削除。
- 発注ステータスバッジを英語から日本語表示に変更（下書き・確定・送信済・入荷待ち・納品済・取消）。発注一覧・入出庫管理・ダッシュボードで統一。
- 発注候補から、確定以降（確定・送信済・入荷待ち・納品済）の発注に含まれる品目を除外。取消した発注の品目は再び候補に表示。
- メール送信プレビューから「送信前に注文書を再生成する（別名保存）」チェックボックスを削除。発注一覧の「再生成」ボタンを削除。メール送信時は既存の注文書 PDF をそのまま添付。
- 仕入品フォームのプレースホルダー「既存の品番から選択または新規入力」「既存から選択または新規入力」を削除。単価入力欄のプレースホルダーも削除。
- 購入実績一覧：納入日を入力すると購入月（YYMM）を自動反映。一覧を画面幅いっぱいに表示し、横スクロールを抑えるレイアウト（table-layout: fixed・列幅配分・セル折り返し）に変更。
- データ管理の「購入品管理」タブを削除。購入品管理はナビの単独メニューから `/purchase-results` で利用。

### Fixed
- 発注入庫（発注管理からの入庫計上）の取引時刻を JST で記録するよう修正。在庫取引の `occurred_at` を JST で統一し、履歴の時系列が正しく表示されるように改善。
- `InventoryTransaction.occurred_at` のデフォルトを JST に変更（`_jst_now`）。新規取引はすべて JST で記録。
- 発注メール送信成功後の DB 保存で、EmailSendLog の `subject` / `body` が None にならないようフォールバックを追加。commit 前に `flush()` を実行し制約違反を早期検出。

## [0.3.0] - 2026-02-10
### Added
- 一般ユーザー向けの公開利用：ルート `/`・ダッシュボード `/dashboard`・在庫一覧 `/inventory` をログイン不要で閲覧可能に。アプリ起動時は一般ユーザーとして利用し、管理者ログイン時のみ発注・入出庫・データ管理等を利用可能。
- ログイン状態の保持：環境変数 `APP_SESSION_MAX_AGE`（秒）でセッション有効期限を指定可能。既定は 14 日間。同一ブラウザ・端末（PC/タブレット）ごとにセッションが保持される。`0` の場合はブラウザ終了まで。
- ログイン画面に「端末ごとにログイン状態が保持される」旨の説明を追加。
- ログイン画面 `/login` とセッション認証を導入。`app_users` テーブルのロール（`viewer` / `manager` / `admin`）に応じて画面/APIアクセスを制御し、初期管理者の自動作成にも対応。
- ダッシュボード `/dashboard` を新設。KPI、要発注品目、発注ステータス、入庫待ち、直近トランザクションを一画面で確認可能に。
- 入出庫管理 `/logistics` を新設。送信済み発注を入庫待ちとして表示し、分納（明細ごとの今回入荷数）に対応した入庫計上を実装。
- データ管理を機能別ページへ分割。`/manage/suppliers`（仕入先）・`/manage/items`（仕入品）・`/manage/email-settings`（メール設定, adminのみ）を追加。
- メール設定API（`GET/PUT /api/email-settings`）とアカウント別パスワード保存API（`POST /api/email-settings/accounts/{account_key}/password`）を追加。
- 注文書PDFテンプレート `purchase_order_document.html` を追加し、Playwright生成PDFのレイアウトを改善。
- 入出庫・発注・データ管理の主要画面へトースト通知/処理中スピナーを追加。

### Changed
- ルート `/` の遷移先を `/inventory` から `/dashboard` へ変更。ログイン後の既定遷移先も `/dashboard` に統一。
- ナビゲーションの「ダッシュボード」リンクを有効化（`#` -> `/dashboard`）。
- 発注取消時の挙動を調整。取消対象の発注データをDBから削除し、PO番号を再利用可能に変更。
- 仕入先連絡先の扱いを整理。`メールCC` 依存を縮小し、`アシスタント名` / `アシスタントメール` を中心にUI/APIを統一。
- メール設定のアカウント構造を拡張。`accounts.*.department` を保持し、部署デフォルトとの整合チェックを実施。
- 画面遷移時の成功通知をフラッシュトースト方式に変更し、高速処理時でも結果確認できるように調整（最小スピナー表示時間を適用）。
- 入出庫管理の実行確認をブラウザ標準 `confirm` からアプリ内モーダルに置換。

### Fixed
- 仕入先ごと一括作成で同一内容が二重作成される問題を修正。
- 発注管理画面（`orders.html`）のJavaScript構文エラーを修正。
- `Mail Settings` で部署変更等の設定反映が不十分だった問題を修正し、更新内容がJSONへ正しく保存されるよう改善。
- 在庫/発注/入出庫の高速処理でトーストやスピナーが瞬時に消えて確認しづらい問題を修正。
- 旧データとの互換のため、`suppliers.email_cc` -> `assistant_email` への補完移行を `init_db()` で実施。

### Deps
- `requirements.txt` に `keyring>=25.0.0` と `playwright>=1.50.0` を追加。

## [0.2.0] - 2026-02-03
### Added
- 仕入品マスタに「管理/管理外」を導入。DB に `management_type` カラムを追加し、CSV の「管理/管理外」列をインポート。在庫一覧は「管理」のみ表示。
- データ管理の仕入品フォームに「管理/管理外」選択を追加。API（POST/PUT /api/items）で `management_type` を保存・更新。
- 履歴リセット用スクリプト `scripts/reset_inventory_history.py` を追加。`--yes` で確認なし実行可能。
- ナビゲーションに「履歴」を追加（データ管理の右）。履歴専用ページ `/history` を新設し、直近トランザクションを最大 50 件表示。
- データ管理の保存後ダイアログ：仕入品は追加時「品番○○追加完了」、編集時「品番○○ 発注点○→○へ変更完了」等を表示。仕入先は編集時「（担当者、電話を変更）」のように変更項目を表示。
- データ管理の仕入品検索でヒット後、結果カードへ自動スクロール。一覧カードクリック時はページ最上部へスクロール。
- データ管理の仕入先・仕入品一覧カードにマウスオーバー時のハイライト（在庫管理と同様の `hover:bg-slate-100`）を追加。

### Changed
- 在庫不足一覧（発注管理）の部署ツリーから、部署名横の「○カテゴリ」表示を削除。
- データ管理の仕入品編集で品名を不要に。品名未入力時は API 側で品番・種類で補完し、フォームから品名入力欄を削除。
- 在庫一覧で在庫数変更（モーダル確定）後、リロードなしで当該行の背景色（赤/解除）・差分表示・状態バッジを即時更新。
- 履歴表示を在庫一覧の下部から削除し、ナビの「履歴」から専用ページでのみ表示するように変更。在庫一覧のコンテキストから `recent_transactions` を削除。

## [0.1.1] - 2026-02-02
### Added
- 発注管理 `/orders` に在庫一覧と統一感のあるページ構成を導入し、左ペインに部署ツリー・highlightカード・在庫不足ハイライトカードのレイアウトを追加しました。

### Changed
- 差分 +0 も不足扱いの色（赤）に統一し、一覧のカード/hover 表示を在庫一覧と同じように調整しました。

### Fixed
- 低在庫候補のリストをカード化し、hover で強調表示されない問題を修正。これにより発注一覧のマウスオーバーで背景/境界が変化するようになりました。

## [0.1.0] - 2026-01-31
### Added
- 在庫一覧で `/inventory/inline-adjust` による +/- 調整と `/api/inventory/issues`、`/recent-transactions` API を導入し、中央ビュー・履歴を同期させた運用フローを構築。
- `manage_data` ページに仕入先/仕入品の検索付き編集フォームと `POST /api/suppliers` / `PUT /api/suppliers/{id}` / `POST /api/items` / `PUT /api/items/{id}` を実装し、CSV バッチなしでデータの追加・更新が可能に。
- 発注管理ページ `/orders` と `purchase_orders` 系テーブル／APIを追加し、発注登録・受領入力・ステータス更新・履歴記録を在庫トランザクションと連動させた仕組みを実現。
### Changed
- `/inventory/inline-adjust` は `tx_type=ADJUST` 固定・`reason` 任意化を明記し、既存の出庫/調整 API（および履歴取得）はそのまま保った上で UX をスムーズに。
- 管理画面では検索入力に `datalist` を追加して入力候補を表示、一覧クリックでフォームへスクロール、仕入先の全カラムを並べて UX を改善。
### Fixed
- `ZoneInfo("Asia/Tokyo")` 周りの `tzdata` 依存を満たし、直近履歴やダイアログのタイムスタンプを安定的に JST で表示できるように修正。
### Deps
- `requirements.txt` に `tzdata` / `python-multipart` を追加して zoneinfo/tzdata と multipart フォームの実行環境を整備。
