# Changelog

## [0.3.0] - 2026-02-10
### Added
- 一般ユーザー向けの公開利用：ルート `/`・ダッシュボード `/dashboard`・在庫一覧 `/inventory` をログイン不要で閲覧可能に。アプリ起動時は一般ユーザーとして利用し、管理者ログイン時のみ発注・入出荷・データ管理等を利用可能。
- ログイン状態の保持：環境変数 `APP_SESSION_MAX_AGE`（秒）でセッション有効期限を指定可能。既定は 14 日間。同一ブラウザ・端末（PC/タブレット）ごとにセッションが保持される。`0` の場合はブラウザ終了まで。
- ログイン画面に「端末ごとにログイン状態が保持される」旨の説明を追加。
- ログイン画面 `/login` とセッション認証を導入。`app_users` テーブルのロール（`viewer` / `manager` / `admin`）に応じて画面/APIアクセスを制御し、初期管理者の自動作成にも対応。
- ダッシュボード `/dashboard` を新設。KPI、要発注品目、発注ステータス、入庫待ち、直近トランザクションを一画面で確認可能に。
- 入出荷管理 `/logistics` を新設。送信済み発注を入庫待ちとして表示し、分納（明細ごとの今回入荷数）に対応した入庫計上を実装。
- データ管理を機能別ページへ分割。`/manage/suppliers`（仕入先）・`/manage/items`（仕入品）・`/manage/email-settings`（メール設定, adminのみ）を追加。
- メール設定API（`GET/PUT /api/email-settings`）とアカウント別パスワード保存API（`POST /api/email-settings/accounts/{account_key}/password`）を追加。
- 注文書PDFテンプレート `purchase_order_document.html` を追加し、Playwright生成PDFのレイアウトを改善。
- 入出荷・発注・データ管理の主要画面へトースト通知/処理中スピナーを追加。

### Changed
- ルート `/` の遷移先を `/inventory` から `/dashboard` へ変更。ログイン後の既定遷移先も `/dashboard` に統一。
- ナビゲーションの「ダッシュボード」リンクを有効化（`#` -> `/dashboard`）。
- 発注取消時の挙動を調整。取消対象の発注データをDBから削除し、PO番号を再利用可能に変更。
- 仕入先連絡先の扱いを整理。`メールCC` 依存を縮小し、`アシスタント名` / `アシスタントメール` を中心にUI/APIを統一。
- メール設定のアカウント構造を拡張。`accounts.*.department` を保持し、部署デフォルトとの整合チェックを実施。
- 画面遷移時の成功通知をフラッシュトースト方式に変更し、高速処理時でも結果確認できるように調整（最小スピナー表示時間を適用）。
- 入出荷管理の実行確認をブラウザ標準 `confirm` からアプリ内モーダルに置換。

### Fixed
- 仕入先ごと一括作成で同一内容が二重作成される問題を修正。
- 発注管理画面（`orders.html`）のJavaScript構文エラーを修正。
- `Mail Settings` で部署変更等の設定反映が不十分だった問題を修正し、更新内容がJSONへ正しく保存されるよう改善。
- 在庫/発注/入出荷の高速処理でトーストやスピナーが瞬時に消えて確認しづらい問題を修正。
- 旧データとの互換のため、`suppliers.email_cc` -> `assistant_email` への補完移行を `init_db()` で実施。

### Deps
- `requirements.txt` に `keyring>=25.0.0` と `playwright>=1.50.0` を追加。

## [0.2.0] - 2026-02-03
### Added
- 仕入品マスタに「管理/管理外」を導入。DB に `management_type` カラムを追加し、CSV の「管理/管理外」列をインポート。在庫一覧は「管理」のみ表示。
- データ管理の仕入品フォームに「管理/管理外」選択を追加。API（POST/PUT /api/items）で `management_type` を保存・更新。
- 履歴リセット用スクリプト `scripts/reset_inventory_history.py` を追加。`--yes` で確認なし実行可能。
- ナビゲーションに「履歴」を追加（データ管理の右）。履歴専用ページ `/history` を新設し、直近トランザクションを最大 50 件表示。
- データ管理の保存後ダイアログ：仕入品は追加時「品番○○追加完了」、編集時「品番○○ 発注点○→○へ変更完了」等を表示。仕入先は編集時「（担当者、電話を変更）」のように変更項目を表示。
- データ管理の仕入品検索でヒット後、結果カードへ自動スクロール。一覧カードクリック時はページ最上部へスクロール。
- データ管理の仕入先・仕入品一覧カードにマウスオーバー時のハイライト（在庫管理と同様の `hover:bg-slate-100`）を追加。

### Changed
- 在庫不足一覧（発注管理）の部署ツリーから、部署名横の「○カテゴリ」表示を削除。
- データ管理の仕入品編集で品名を不要に。品名未入力時は API 側で品番・種類で補完し、フォームから品名入力欄を削除。
- 在庫一覧で在庫数変更（モーダル確定）後、リロードなしで当該行の背景色（赤/解除）・差分表示・状態バッジを即時更新。
- 履歴表示を在庫一覧の下部から削除し、ナビの「履歴」から専用ページでのみ表示するように変更。在庫一覧のコンテキストから `recent_transactions` を削除。

## [0.1.1] - 2026-02-02
### Added
- 発注管理 `/orders` に在庫一覧と統一感のあるページ構成を導入し、左ペインに部署ツリー・highlightカード・在庫不足ハイライトカードのレイアウトを追加しました。

### Changed
- 差分 +0 も不足扱いの色（赤）に統一し、一覧のカード/hover 表示を在庫一覧と同じように調整しました。

### Fixed
- 低在庫候補のリストをカード化し、hover で強調表示されない問題を修正。これにより発注一覧のマウスオーバーで背景/境界が変化するようになりました。

## [0.1.0] - 2026-01-31
### Added
- 在庫一覧で `/inventory/inline-adjust` による +/- 調整と `/api/inventory/issues`、`/recent-transactions` API を導入し、中央ビュー・履歴を同期させた運用フローを構築。
- `manage_data` ページに仕入先/仕入品の検索付き編集フォームと `POST /api/suppliers` / `PUT /api/suppliers/{id}` / `POST /api/items` / `PUT /api/items/{id}` を実装し、CSV バッチなしでデータの追加・更新が可能に。
- 発注管理ページ `/orders` と `purchase_orders` 系テーブル／APIを追加し、発注登録・受領入力・ステータス更新・履歴記録を在庫トランザクションと連動させた仕組みを実現。
### Changed
- `/inventory/inline-adjust` は `tx_type=ADJUST` 固定・`reason` 任意化を明記し、既存の出庫/調整 API（および履歴取得）はそのまま保った上で UX をスムーズに。
- 管理画面では検索入力に `datalist` を追加して入力候補を表示、一覧クリックでフォームへスクロール、仕入先の全カラムを並べて UX を改善。
### Fixed
- `ZoneInfo("Asia/Tokyo")` 周りの `tzdata` 依存を満たし、直近履歴やダイアログのタイムスタンプを安定的に JST で表示できるように修正。
### Deps
- `requirements.txt` に `tzdata` / `python-multipart` を追加して zoneinfo/tzdata と multipart フォームの実行環境を整備。
