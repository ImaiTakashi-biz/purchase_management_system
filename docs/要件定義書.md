# 購入品一元管理システム 要件定義書（UI反映版・DB構築まで）

## 1. 背景・目的
本システムは、社内で使用する購入品（刃物・検査治具・工具・消耗品・備品等）を  
**在庫管理・発注管理・納品管理**まで一元管理する社内向けWebアプリである。

従来Notionで試行していたが、
- データ構造と業務フローの乖離
- UI導線の複雑化
- 権限・履歴管理の限界  
により断念し、**FastAPIベースのWebアプリとして再設計**する。

---

## 2. 想定利用者・利用環境
- 利用者：生産部／品質保証部／営業部／総務部／DIP部
- 利用端末：PCブラウザ／iPhone／iPad／Androidタブレット
- 利用形態：社内LAN上のWebアプリ（社内サーバー常駐）
- 同時接続目安：20〜50人（将来PostgreSQL前提）

---

## 3. UI設計方針（最重要）
### 3.1 UI完成形の基準
添付の **管理コンソール型UI（ダッシュボード＋サイドバー）** を、UIの完成形イメージとする。  
※ Swagger UI（/docs）は開発者確認用であり、利用者UIとして使用しない。

### 3.2 UI資産の取り込み方針（プロジェクトに格納）
Cursorプロジェクト内に、ユーザー提示のUI資産を格納して実装のベースとする。

- `ui_reference/`（参照用。実装のベース）
  - `dashboard.html`：添付のHTML（UIデザイン参照用）
  - `screen.png`：添付の画像（UI見本）
- 実装側は以下に反映する（Jinja2前提）
  - `app/web/templates/`：画面テンプレート
  - `app/web/static/`：CSS/JS/画像（必要なら）

> 参照HTMLをそのままユーザー向けに配信するのではなく、  
> **要件に合わせて日本語化・メニュー名変更・不要要素削除**し、テンプレートへ落とし込む。

### 3.3 トップ画面に常時表示する要素（添付UI準拠）
- ヘッダ
  - アプリ名
  - メニュー（Overview / Inventory / Orders / Reporting）※表示文言は日本語にする
  - 検索ボックス
  - 通知アイコン
  - ユーザーアイコン
- サイドバー
  - 部署別カテゴリツリー
  - 在庫カテゴリ（工具・消耗品・清掃用品 等）
- メイン領域（ダッシュボード）
  - KPIカード（総品目数／要対応件数／在庫不足件数／本日納品予定）
  - 一覧エリア（在庫不足、最近の出庫/調整、発注状況のサマリ）

---

## 4. 画面遷移（最低要件）
- Overview（トップ） → 在庫管理（Inventory）
- Overview（トップ） → 発注管理（Orders）
- Overview（トップ） → 納品管理（Deliveries）
- 各機能ページは「一覧→詳細/登録（モーダルor別ページ）」の最小導線とする

---

## 5. 機能要件（MVP）
### 5.1 在庫管理（最優先）
- 在庫一覧表示（検索・カテゴリ絞り込み）
- 出庫登録（一般ユーザー可）
- 在庫調整（一般ユーザー可、**理由必須**）
- 入出庫履歴参照（最新順、フィルタ可能）
- 在庫状態の色分け（十分／注意／不足）

### 5.2 発注管理（MVPは“画面＋一覧”まで）
- 発注待ち一覧／発注済一覧
- 発注登録（詳細ロジックは後続）
- 発注履歴参照

### 5.3 納品管理（MVPは“画面＋登録”まで）
- 納品登録（伝票単位）
- 納品書画像アップロード（OCRは将来）
- 検収登録 → 在庫入庫反映（最小）

---

## 6. 業務ルール（確定）
- 承認フロー：なし
- 在庫は「直接編集禁止」。必ずトランザクション（出庫/調整/入庫）で増減
- 調整は理由必須（出庫忘れ・誤入力を前提に救済できること）
- 履歴は削除・編集禁止（訂正は逆仕訳＝新規トランザクション）

---

## 7. 非機能要件
- UI文言はすべて **日本語（業務用語）**
- Swagger UI は開発者確認用のみ（利用者には非公開）
- 社内サーバー運用を前提（`uvicorn app.main:app ...` 等の標準運用）
- ログ出力（障害解析のため最低限）

---

# 8. データベース要件（構築まで）

## 8.1 DB方針
- MVP：SQLite（開発・小規模運用）
- 本番：PostgreSQL（同時書き込み・拡張性のため）
- ORM：SQLAlchemy
- マイグレーション：Alembic（推奨）
  - MVP段階で簡易に `create_all` を使う場合でも、早期にAlembicへ移行できる前提で設計する

## 8.2 必須テーブル（MVP）
### (1) items（品目マスタ：最小）
- `id`（PK）
- `item_code`（任意：品番）
- `name`（品名）
- `category`（例：刃物/治具/消耗品/清掃 等）
- `unit`（例：pcs/本/箱）
- `reorder_point`（発注点：任意）
- `is_active`
- `created_at`, `updated_at`

> ※ 初期は品目マスタが未整備でも運用できるように、在庫トランザクション側で `item_name_free` を持つ案も可。  
> ただしMVPはまず items を用意する。

### (2) inventory_items（現在庫）
- `id`（PK）
- `item_id`（FK → items.id）※UNIQUE
- `quantity_on_hand`（現在庫）
- `updated_at`

### (3) inventory_transactions（在庫履歴：最重要）
- `id`（PK）
- `item_id`（FK → items.id）
- `tx_type`（enum：`receipt` / `issue` / `adjust`）
- `delta`（増減量：入庫+、出庫-、調整±）
- `reason`（調整理由：`adjust` 時必須）
- `note`（任意）
- `occurred_at`（任意：現場での発生時刻。未指定ならサーバー時刻）
- `created_by`（任意：MVPは暫定値でも可、将来認証で実ユーザー）
- `created_at`

**制約（必須）**
- 在庫数量の変更は必ず `inventory_transactions` を生成して実施
- `adjust` は `reason` 必須（APIとDBで担保）

## 8.3 推奨テーブル（MVP後半〜）
- `suppliers`（仕入先）
- `purchase_orders` / `purchase_order_lines`（発注）
- `deliveries` / `delivery_lines`（納品：1伝票＝複数品目）
- `email_send_logs`（Outlook送信ログ：監査）

---

## 9. API方針（在庫MVPの範囲）
- GET  `/inventory`（在庫一覧）
- POST `/inventory/issues`（出庫）
- POST `/inventory/adjustments`（調整：理由必須）
- GET  `/inventory/transactions`（履歴）

> UI操作（モーダル）から上記APIを呼び出す前提で設計する。

---

## 10. ゴール
- 添付UIイメージと乖離しない「管理コンソール型UI」を実装する
- 在庫管理（出庫・調整・履歴）が現場で回る状態を作る
- 将来の発注・納品・OCR・メール送信へ拡張できるDB/構成を確立する


---

## 8.4 初期データ投入方針（CSVインポート）

### 8.4.1 前提
本システムのDB初期構築時は、**既存管理データをCSVファイルからインポート**して初期データを作成する。  
手入力による初期登録は行わず、CSVを正とする。

インポート対象CSVは以下とする。

- `仕入品マスタ.csv`
- `仕入先マスタ.csv`

---

### 8.4.2 仕入品マスタ.csv → items テーブル

**想定CSV項目（例）**
- 品番
- 品名
- カテゴリ
- 単位
- 発注点
- 使用部署
- 備考

**取り込みルール**
- CSVの1行＝itemsテーブルの1レコード
- 品番＋品名を基本キーとして重複チェックを行う
- 未指定項目はNULL許容
- 初期在庫数はこのCSVでは管理しない（在庫は別途トランザクションで反映）

---

### 8.4.3 仕入先マスタ.csv → suppliers テーブル

**想定CSV項目（例）**
- 仕入先コード
- 仕入先名
- 担当者名
- メールアドレス
- 電話番号
- 備考

**取り込みルール**
- CSVの1行＝suppliersテーブルの1レコード
- 仕入先コードが存在する場合はユニーク制約を設ける
- メールアドレス・電話番号は文字列として保持（形式チェックは後続対応）

---

### 8.4.4 インポート処理方針（実装前提）
- Python（pandas + SQLAlchemy）によるバッチ処理で実施
- 初期構築時 or 明示的な管理者操作でのみ実行
- 再実行時は以下のいずれかを選択できる設計とする
  - 全削除 → 再投入
  - 差分更新（キー一致時は更新）

※ MVPでは **全削除→再投入** を基本とし、差分更新は将来対応でも可。

---

### 8.4.5 在庫初期値の考え方
- 在庫数は CSV では直接持たせない
- 初期在庫が存在する場合は
  - `inventory_transactions` に
    - `tx_type = receipt`
    - `delta = 初期在庫数`
    - `reason = '初期在庫投入'`
  を投入することで整合性を保つ

---

