# 購入品・仕入先一元管理 実装案

## 1. 要件の整理

### 1.1 達成したいこと
- **同品番で複数仕入先**を扱い、品番ごとに仕入先を選べるようにする。
- 発注管理で**品番＋仕入先**を選ぶと**DBの単価が即反映**される。
- 品番は仕入品マスタにあり・仕入先は仕入先マスタにあり、その**組み合わせが未登録**のとき、**発注確定で自動登録**する。
- **入庫管理**で**納入日・納品書番号**を入力できるようにする。
- 入庫時に**単価を変更**した場合は**DBに反映し、変更前後の履歴**を残す。
- 入庫計上した内容を**仕入先の伝票単位**で**購入品管理（総務・資産計上用）**に渡し、将来的に**Excelエクスポート**できるようにする。

### 1.2 仕入品DBの追加項目（画像・Access 購入実績との対応）
- **科目名**（仕入品マスタに追加）
- **費目名**（仕入品マスタに追加）
- その他（購入月・購入者名・納入日・納品書番号など）は購入品管理テーブルまたは入庫時の入力で管理し、仕入品マスタとは連動不要。

### 1.3 ルール
- **購入月**: 西暦下2桁＋月2桁の4桁（例: 2503）。納入日から自動算出。
- **購入者**: 発注担当者名を使用。
- **納入日・納品書番号**: 入庫管理画面で入力する。

---

## 2. データベース設計案

### 2.1 同品番・複数仕入先の扱い

**方針**: 「品番（Item）」は1レコード1品番のままとする。**品番＋仕入先ごとの単価**は別テーブルで管理する。

| テーブル | 役割 |
|----------|------|
| **items**（既存） | 品番・品名・発注点・科目名・費目名など。`supplier_id` は「代表仕入先」または廃止。 |
| **item_suppliers**（新規） | 品番×仕入先の組み合わせと単価。発注時の「この品番をこの仕入先で」の選択と単価の参照元。 |

**item_suppliers 案**

| カラム | 型 | 説明 |
|--------|-----|------|
| id | PK | |
| item_id | FK → items | 仕入品 |
| supplier_id | FK → suppliers | 仕入先 |
| unit_price | Integer, nullable | 単価（円） |
| created_at, updated_at | DateTime | |

- **ユニーク**: (item_id, supplier_id)
- 既存の `items.unit_price` は「代表仕入先用」として残すか、廃止して item_suppliers に一本化するかは運用次第（案では item_suppliers に一本化し、items.unit_price は後方互換または代表用に残す）。

### 2.2 仕入品マスタの追加項目

**items テーブルに追加**

| カラム | 型 | 説明 |
|--------|-----|------|
| account_name | String(128), nullable | 科目名 |
| expense_item_name | String(128), nullable | 費目名 |

### 2.3 単価変更履歴（入庫時に単価を書き換えた場合）

**unit_price_history 案**

| カラム | 型 | 説明 |
|--------|-----|------|
| id | PK | |
| item_id | FK → items | |
| supplier_id | FK → suppliers | |
| old_unit_price | Integer, nullable | 変更前単価 |
| new_unit_price | Integer | 変更後単価 |
| changed_at | DateTime | 変更日時 |
| changed_by | String(128) | 操作者 |
| source | String(64) | 例: "入庫計上", "発注確定" |
| reference_id | Integer, nullable | 入庫明細IDや発注明細IDなど |

- 入庫画面で単価を変更して確定したときに 1 件挿入し、あわせて `item_suppliers.unit_price` を更新。

### 2.4 購入品管理（購入実績）テーブル

入庫計上を「仕入先の伝票ごと」に購入実績として残し、総務の資産計上・Excel出力に使う。

**purchase_results 案**（Access 購入実績照会に相当）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | PK | |
| delivery_date | Date | 納入日（入庫時入力） |
| supplier_id | FK → suppliers | 購入先 |
| delivery_note_number | String(64), nullable | 納品書番号（入庫時入力） |
| item_id | FK → items | 品番・品名は item から取得 |
| quantity | Integer | 数量 |
| unit_price | Integer | 単価（入庫時確定値） |
| amount | Integer | 金額（単価×数量） |
| purchase_month | String(4) | 購入月 YYMM（納入日から自動） |
| account_name | String(128), nullable | 科目名（item からコピー） |
| expense_item_name | String(128), nullable | 費目名（item からコピー） |
| purchaser_name | String(128), nullable | 購入者（発注担当者） |
| note | Text, nullable | 備考 |
| source_order_id | Integer, nullable | 元の発注ID（参照用） |
| source_line_id | Integer, nullable | 元の発注明細ID（参照用） |

- 入庫計上確定時に、**伝票（納入日＋仕入先＋納品書番号）単位**で 1 行ずつ、または明細単位で行を挿入する。
- 購入月は `delivery_date` から YYMM を算出してセット。
- 購入者は発注担当者（order.ordered_by_user 等）をセット。

---

## 3. 機能別実装案

### 3.1 発注管理「品番ごとに仕入先を選択」

1. **発注候補の出し方**
   - 現状: 在庫不足の「品番」を候補として表示し、1品番1仕入先（items.supplier_id）で単価表示。
   - 変更案:
     - 候補は「品番」単位で出す（在庫不足の item 一覧）。
     - 各行に**仕入先**のドロップダウンを追加。選択肢は「その品番が紐づく仕入先（item_suppliers に存在する supplier_id）」＋ 必要なら「その他の仕入先マスタ」。
     - 仕入先を選んだ時点で、**item_suppliers の unit_price** を参照して単価欄に表示。未登録の組み合わせなら単価は空または「未登録」とし、発注確定時に自動登録する。

2. **発注確定時の自動登録**
   - 発注確定（注文書作成またはステータスを確定にしたタイミング）時に、各明細の (item_id, supplier_id) をチェック。
   - `item_suppliers` に存在しなければ 1 行挿入。単価は発注時の入力値（または明細の単価）で保存。
   - これで「品番はマスタにあり・仕入先もマスタにあり・組み合わせだけ新規」の場合に自動で登録される。

3. **API・データ**
   - 発注候補 API で、品番ごとに「選択可能な仕入先と単価」のリストを返す（item_suppliers を参照）。
   - フロント: 品番行ごとに仕入先を選択し、選択に応じて単価を表示。数量変更で金額リアルタイム更新は現状どおり。

### 3.2 入庫管理の拡張

1. **納入日・納品書番号の入力**
   - 入庫計上画面（入出庫管理）で、**伝票単位**で「納入日」「納品書番号」を入力できるようにする。
   - 例: 発注単位で 1 伝票とみなす場合は、発注ごとに納入日・納品書番号を 1 セット入力。分納の場合は「今回入庫分」ごとに入力するか、発注単位で 1 回だけ入力するかは運用で決定。

2. **単価の表示・変更**
   - 入庫計上画面の明細に**単価**を表示する。元データは発注明細または item_suppliers。
   - 単価を**編集可能**にし、変更して確定した場合:
     - `unit_price_history` に変更前・変更後を 1 件挿入。
     - 該当する `item_suppliers.unit_price` を更新（次回発注から反映）。

3. **購入実績への連携**
   - 入庫計上確定処理の最後に、その入庫内容を `purchase_results` に挿入する。
   - 納入日・納品書番号・単価（変更後）・数量・金額・購入月・科目名・費目名・購入者 をセット。
   - 伝票単位で 1 行にするか、明細単位で複数行にするかは仕様で決定（検索・Excel のしやすさで明細単位を推奨）。

### 3.3 購入品管理画面（新規）

1. **一覧**
   - `purchase_results` を一覧表示。納入日・購入先・納品書番号・品名・数量・単価・金額・購入月・科目名・費目名・購入者・備考 など。
   - フィルタ: 納入日範囲、購入月、仕入先、品番など。

2. **Excel エクスポート（将来）**
   - 一覧の検索結果を CSV/Excel でダウンロード。Access 購入実績照会と同様の列構成にすると親しみやすい。

### 3.4 仕入品マスタ（データ管理）の変更

1. **科目名・費目名**
   - 仕入品の新規登録・編集フォームに「科目名」「費目名」を追加（仕入先の下または単価の近く）。
   - 一覧・API でこれらの項目を返す。

2. **単価の扱い（item_suppliers 導入後）**
   - 仕入品マスタ画面では「代表」または「主な仕入先」の単価を 1 つ表示・編集するか、**品番×仕入先別の単価一覧**を別タブで編集する形が考えられる。
   - まずは「品番×仕入先」は発注・入庫の流れで自動登録し、マスタ画面では科目名・費目名のみ追加する実装でも可。

---

## 4. 実装フェーズ案

| フェーズ | 内容 | 優先度 |
|----------|------|--------|
| **Phase 1** | items に 科目名・費目名 追加。仕入品フォーム・API 対応。 | 高 |
| **Phase 2** | item_suppliers テーブル追加。発注候補で「品番＋仕入先」選択と単価表示（item_suppliers 優先、無ければ items.unit_price）。発注確定時の (item_id, supplier_id) 自動登録。 | 高 |
| **Phase 3** | 入庫計上画面に 納入日・納品書番号 入力欄追加。入庫確定時に purchase_results へ挿入（購入月・購入者などもセット）。 | 高 |
| **Phase 4** | 入庫画面で単価の表示・編集。変更時は unit_price_history に記録し、item_suppliers を更新。 | 中 |
| **Phase 5** | 購入品管理画面（一覧・検索）の新設。 | 中 |
| **Phase 6** | 購入品管理の Excel（CSV）エクスポート。 | 低 |

---

## 5. 注意点・確認事項

1. **品番の一意性**  
   items は「品番（item_code）はユニーク」のまま。同一品番で複数仕入先は **item_suppliers** で表現する。

2. **既存データの移行**  
   既存の items.supplier_id と items.unit_price がある場合、初回マイグレーションで item_suppliers に「既存の (item_id, supplier_id) と unit_price」を 1 件ずつ投入する処理があると安全。

3. **発注明細の supplier**  
   発注は「1 発注 = 1 仕入先」なので、order に supplier_id がある。明細の単価は発注時点の item_suppliers または上書き値を持たせる（purchase_order_lines に unit_price を持たせるか、発注時は item_suppliers を参照するだけかは設計で決定）。

4. **購入月の算出**  
   納入日が null の場合は購入月も null または「未設定」とする。納入日ありなら `delivery_date.strftime("%y%m")` で YYMM をセット。

5. **購入者**  
   発注担当者（ordered_by_user）を購入者として purchase_results に保存。入庫のみのケース（発注なし）は「入力者」や「—」とするか仕様で決定。

---

## 6. まとめ

- **同品番・複数仕入先**: `item_suppliers` で「品番×仕入先×単価」を管理し、発注画面で品番ごとに仕入先を選び、単価を即時表示。
- **発注確定時**: 品番・仕入先の組み合わせが未登録なら `item_suppliers` に自動登録。
- **仕入品マスタ**: 科目名・費目名を追加。単価は item_suppliers を主とし、必要に応じて items.unit_price は代表用に残す。
- **入庫管理**: 納入日・納品書番号を入力。単価変更時は履歴テーブルに記録し、item_suppliers を更新。
- **購入品管理**: 入庫計上結果を `purchase_results` に伝票/明細単位で保存。一覧画面と将来的な Excel エクスポートで総務の資産計上に利用する。

この案に沿って Phase 1 から順に実装すると、運用が分かりやすく、Access 購入実績照会からの移行も行いやすくなります。
